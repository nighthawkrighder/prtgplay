<!DOCTYPE html>
<!-- SOC Dashboard v2.1 - Updated 2025-10-08 - WebSocket Fix -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>LANAIR Unified Monitoring Dashboard - PRTG</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 4px 25px rgba(0,0,0,0.6), 0 0 30px rgba(52, 152, 219, 0.2); }
            50% { box-shadow: 0 4px 25px rgba(0,0,0,0.6), 0 0 50px rgba(52, 152, 219, 0.4); }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e, #0f1e30);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            color: #ffffff;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(52, 152, 219, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .startup-progress-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 18, 36, 0.92);
            backdrop-filter: blur(6px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .startup-progress-overlay.visible {
            display: flex;
            opacity: 1;
        }

        .startup-progress-card {
            width: min(400px, 90vw);
            background: linear-gradient(135deg, rgba(52, 73, 94, 0.85), rgba(44, 62, 80, 0.95));
            border: 1px solid rgba(46, 134, 222, 0.4);
            border-radius: 16px;
            padding: 1.75rem;
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
            text-align: center;
        }

        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin: 1.5rem 0;
            height: 40px;
        }

        .spinner-ball {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            animation: bounce 1.4s infinite ease-in-out both;
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.4);
        }

        .spinner-ball:nth-child(1) {
            animation-delay: -0.32s;
        }

        .spinner-ball:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0) translateY(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1) translateY(-20px);
                opacity: 1;
            }
        }

        .startup-progress-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #eaf2ff;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .startup-progress-message {
            font-size: 0.95rem;
            color: #cfd9ff;
            margin-bottom: 1.25rem;
            min-height: 1.2rem;
        }

        .startup-progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 999px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .startup-progress-fill {
            height: 100%;
            width: 0;
            background: linear-gradient(135deg, #2ecc71, #3498db);
            border-radius: 999px;
            transition: width 0.4s ease;
        }

        .startup-progress-percent {
            font-size: 0.9rem;
            color: #9ac2ff;
            letter-spacing: 0.05em;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f0f23);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            border-bottom: 3px solid #3498db;
            box-shadow: 0 4px 25px rgba(0,0,0,0.6);
            position: sticky;
            top: 0;
            z-index: 100;
            animation: glow 6s ease-in-out infinite;
        }
            z-index: 100;
        }

        .header-top {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 1rem 2rem;
            gap: 2rem;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            justify-self: start;
        }

        .controlpoint-logo {
            height: 45px;
            width: auto;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.2));
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .controlpoint-logo:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .brand-text h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
            line-height: 1.2;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            justify-self: end;
        }

        .session-expiry-flag {
            display: none;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0.6rem;
            border-radius: 999px;
            background: rgba(243, 156, 18, 0.15);
            border: 1px solid rgba(243, 156, 18, 0.4);
            color: #f1c40f;
            font-size: 0.8rem;
        }
        .session-expiry-flag.critical {
            background: rgba(231, 76, 60, 0.15);
            border-color: rgba(231, 76, 60, 0.5);
            color: #e74c3c;
        }

        .admin-quick-menu {
            position: relative;
        }

        .admin-portal-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #f5f5f5;
            padding: 0.55rem 0.65rem;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .admin-portal-btn:hover,
        .admin-portal-btn.active {
            background: rgba(39, 174, 96, 0.2);
            border-color: rgba(39, 174, 96, 0.6);
            color: #2ecc71;
        }

        .admin-quick-dropdown {
            position: absolute;
            top: 130%;
            right: 0;
            min-width: 200px;
            background: rgba(30, 30, 50, 0.95);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.45);
            backdrop-filter: blur(12px);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s ease;
            z-index: 150;
            display: flex;
            flex-direction: column;
        }

        .admin-quick-dropdown.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .admin-quick-dropdown .admin-link {
            padding: 0.65rem 0.9rem;
            display: flex;
            gap: 0.6rem;
            align-items: center;
            color: #d0d6ff;
            text-decoration: none;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255,255,255,0.07);
        }

        .admin-quick-dropdown .admin-link:last-child {
            border-bottom: none;
        }

        .admin-quick-dropdown .admin-link:hover {
            background: rgba(39, 174, 96, 0.15);
            color: #2ecc71;
        }

        .user-menu-container {
            position: relative;
        }

        .user-menu-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.6rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .user-menu-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.3);
        }

        .username-display {
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(30, 30, 50, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            min-width: 250px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }

        .user-menu-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
        }

        .user-avatar {
            font-size: 2rem;
            color: #3498db;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: white;
            font-size: 0.9rem;
        }

        .user-role {
            font-size: 0.75rem;
            color: #95a5a6;
            margin-top: 0.2rem;
        }

        .menu-separator {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 0.5rem 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            color: #bdc3c7;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .menu-item.logout {
            color: #e74c3c;
        }

        .menu-item.logout:hover {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        .security-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 99999;
        }

        .security-modal .modal-backdrop {
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .security-modal .modal-content {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .security-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 1.5rem 0 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .security-modal .modal-header h3 {
            margin: 0;
            color: white;
            font-size: 1.2rem;
        }

        .security-modal .modal-body {
            padding: 1.5rem;
        }

        /* Authentication Screen Styles */
        .authentication-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-container {
            background: rgba(30, 30, 50, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            max-width: 450px;
            width: 90%;
            padding: 0;
            overflow: hidden;
        }

        .auth-header {
            text-align: center;
            padding: 2rem 2rem 1rem 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .auth-logo {
            height: 60px;
            width: auto;
            margin-bottom: 1rem;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));
        }

        .auth-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ffffff;
            margin: 0 0 0.5rem 0;
        }

        .auth-header p {
            color: #95a5a6;
            font-size: 0.9rem;
            margin: 0;
        }

        .auth-form-container {
            padding: 2rem;
        }

        .auth-form h2 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #ffffff;
            margin: 0 0 0.5rem 0;
            text-align: center;
        }

        .auth-description {
            color: #bdc3c7;
            font-size: 0.85rem;
            text-align: center;
            margin: 0 0 2rem 0;
        }

        .auth-field {
            margin-bottom: 1.5rem;
        }

        .auth-field label {
            display: block;
            color: #bdc3c7;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .auth-field input {
            width: 100%;
            padding: 0.875rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: #ffffff;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .auth-field input:focus {
            outline: none;
            border-color: #3498db;
            background: rgba(255,255,255,0.08);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .auth-options {
            margin: 1.5rem 0;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            color: #bdc3c7;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 0.75rem;
            accent-color: #3498db;
        }

        .auth-help-text {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.2);
            border-radius: 6px;
        }

        .auth-help-text p {
            color: #85c1e9;
            font-size: 0.8rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auth-submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            border: none;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .auth-submit-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #2980b9, #1f618d);
            transform: translateY(-1px);
        }

        .auth-submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .auth-error {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: #e74c3c;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-top: 1rem;
            text-align: center;
        }

        .auth-footer {
            padding: 1.5rem 2rem;
            background: rgba(0,0,0,0.2);
            text-align: center;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .auth-footer p {
            color: #7f8c8d;
            font-size: 0.75rem;
            margin: 0 0 1rem 0;
        }

        .auth-security-badges {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .security-badge {
            font-size: 0.7rem;
            color: #95a5a6;
            background: rgba(255,255,255,0.05);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .header-logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            font-weight: bold;
        }

        .header-title-group {
            display: flex;
            flex-direction: column;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #ffffff;
            margin: 0;
            line-height: 1.2;
        }

        .header-subtitle {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin: 0;
            font-weight: 400;
        }

        .telemetry-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 2rem;
            background: rgba(0,0,0,0.1);
            border-top: 1px solid rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            min-height: 50px;
        }

        .telemetry-indicators {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex: 0 0 auto;
        }

        .telemetry-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .telemetry-pulse {
            width: 8px;
            height: 8px;
            background: #27ae60;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .telemetry-alert-icon, .telemetry-warning-icon {
            font-size: 0.9rem;
            opacity: 0.3;
        }

        .telemetry-item.critical .telemetry-alert-icon {
            color: #e74c3c;
            opacity: 1;
            animation: pulse 1.5s infinite;
        }

        .telemetry-item.warning .telemetry-warning-icon {
            color: #f39c12;
            opacity: 1;
            animation: pulse 2s infinite;
        }

        .telemetry-health-bar {
            width: 40px;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            border-radius: 3px;
            width: 93%;
            transition: width 0.3s ease;
        }

        .telemetry-count {
            font-size: 0.85rem;
            font-weight: 600;
            color: #bdc3c7;
            min-width: 30px;
        }

        .telemetry-label {
            font-size: 0.7rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .telemetry-separator {
            width: 1px;
            height: 20px;
            background: rgba(255,255,255,0.1);
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex: 1 1 auto;
            justify-content: flex-end;
            min-width: 0;
        }

        .search-box {
            flex: 1 1 300px;
            max-width: 400px;
            min-width: 200px;
        }

        .filter-select {
            flex: 0 0 auto;
            min-width: 150px;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-width: 80px;
        }

        .status-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #3498db;
            line-height: 1;
        }

        .status-label {
            font-size: 0.7rem;
            color: #95a5a6;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .status-item.critical .status-value { color: #e74c3c; }
        .status-item.warning .status-value { color: #f39c12; }
        .status-item.success .status-value { color: #27ae60; }

        .header-nav {
            background: rgba(0, 0, 0, 0.2);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .nav-items {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #bdc3c7;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .nav-item:hover {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        .nav-item.active {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .nav-item.external-link {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .nav-item.external-link:hover {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border-color: rgba(46, 204, 113, 0.5);
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .filter-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .filter-select {
            background: rgba(52, 73, 94, 0.8);
            border: 1px solid #3498db;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .connection-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .connection-indicator.connected {
            background: #27ae60;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-content {
            padding: 1rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        .main-content.authenticated {
            display: block;
        }

        .company-section {
            background: rgba(13, 27, 42, 0.6);
            border: 1px solid rgba(52, 152, 219, 0.2);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .overview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: rgba(52, 73, 94, 0.25);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            border-left: 3px solid;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            background: rgba(52, 73, 94, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .stat-card.clickable {
            cursor: pointer;
        }

        .stat-card.clickable:active {
            transform: translateY(0);
        }

        .stat-card.total { 
            border-left-color: #3498db; 
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.2);
        }
        .stat-card.up { 
            border-left-color: #27ae60; 
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.2);
        }
        .stat-card.down { 
            border-left-color: #e74c3c; 
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.2);
            animation: pulse 2s ease-in-out infinite;
        }
        .stat-card.warning { 
            border-left-color: #f39c12; 
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.2);
        }
        .stat-card.companies { 
            border-left-color: #9b59b6; 
            box-shadow: 0 0 20px rgba(155, 89, 182, 0.2);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #ffffff;
        }

        .stat-label {
            text-transform: uppercase;
            font-size: 0.85rem;
            opacity: 0.8;
            font-weight: 500;
        }

        .companies-grid {
            display: grid;
            gap: 0.5rem;
        }

        .auth-btn.authenticated {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
            }

            .header-controls {
                flex-direction: column;
                gap: 1rem;
                width: 100%;
            }

            .filter-controls {
                flex-wrap: wrap;
                justify-content: center;
            }

            .overview-stats {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .company-stats {
                flex-direction: column;
                gap: 1rem;
            }

            .devices-grid {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
        }

        .company-section:hover {
            background: rgba(30, 60, 114, 0.25);
            border-color: rgba(231, 76, 60, 0.3);
        }

        .company-header {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
            min-height: 48px;
        }

        .company-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }        .company-header::after {
            content: 'â–¶';
            position: absolute;
            right: 2rem;
            font-size: 1.2rem;
            color: #e74c3c;
            transition: transform 0.3s ease;
        }

        .company-section.expanded .company-header::after {
            transform: rotate(90deg);
        }

        .company-name-container {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            flex: 1;
        }

        .company-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #e74c3c;
            letter-spacing: 0.3px;
        }

        .company-code {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            border: 1px solid rgba(231, 76, 60, 0.2);
        }        .company-stats {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 45px;
        }

        .stat-value {
            font-weight: 600;
            font-size: 0.9rem;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.65rem;
            color: #95a5a6;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-indicator.up {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
            border: 1px solid #27ae60;
        }

        .status-indicator.warning {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
            border: 1px solid #f39c12;
        }

        .status-indicator.down {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }

        .expand-icon {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
            color: #3498db;
        }

        .company-section.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .company-content {
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s ease;
            background: rgba(0,0,0,0.1);
        }

        .company-section.expanded .company-content {
            max-height: 3000px;
        }

        .devices-grid {
            padding: 0.5rem 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 0.4rem;
            background: rgba(0, 0, 0, 0.08);
        }

        .device-card {
            background: rgba(52, 73, 94, 0.15);
            border-radius: 6px;
            padding: 0.75rem;
            border-left: 3px solid;
            transition: all 0.2s ease;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }

        .device-card:hover {
            background: rgba(52, 73, 94, 0.25);
            border-color: rgba(52, 152, 219, 0.4);
            transform: translateY(-1px);
        }

        .device-card.selected {
            background: rgba(52, 152, 219, 0.2);
            border-color: #3498db;
        }

        .device-card.status-up { border-left-color: #27ae60; }
        .device-card.status-down { border-left-color: #e74c3c; }
        .device-card.status-warning { border-left-color: #f39c12; }
        .device-card.status-paused { border-left-color: #95a5a6; }
        .device-card.status-unusual { border-left-color: #9b59b6; }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .device-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #ffffff;
            line-height: 1.2;
        }

        .device-type {
            font-size: 0.65rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-top: 1px;
        }

        .device-status {
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            line-height: 1;
        }

        .device-details {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem 0.75rem;
            font-size: 0.7rem;
            color: #95a5a6;
        }

        .device-detail {
            display: flex;
            gap: 0.25rem;
        }

        .sensors-summary {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sensor-count {
            font-size: 0.9rem;
            color: #95a5a6;
        }

        .criticality-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .criticality-high {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }

        .criticality-medium {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
            border: 1px solid #f39c12;
        }

        .criticality-low {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
            border: 1px solid #27ae60;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: #bdc3c7;
        }

        .loading::after {
            content: "...";
            animation: dots 2s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ""; }
            40% { content: "."; }
            60% { content: ".."; }
            80%, 100% { content: "..."; }
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: #95a5a6;
        }

        .last-update {
            text-align: center;
            margin-top: 2rem;
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .alert-indicator {
            position: relative;
        }

        .alert-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            animation: pulse-alert 2s infinite;
        }

        @keyframes pulse-alert {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .search-box {
            background: rgba(52, 73, 94, 0.8);
            border: 1px solid #3498db;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.9rem;
            width: 250px;
            outline: none;
        }

        .search-box::placeholder {
            color: #bdc3c7;
        }

        .refresh-btn {
            background: rgba(52, 152, 219, 0.8);
            border: 1px solid rgba(52, 152, 219, 0.6);
            color: white;
            padding: 0.6rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 40px;
        }

        .refresh-btn:hover {
            background: rgba(52, 152, 219, 1);
            border-color: #3498db;
            transform: translateY(-1px);
        }

        .auth-btn {
            background: rgba(243, 156, 18, 0.8);
            border: 1px solid rgba(243, 156, 18, 0.6);
            color: white;
            padding: 0.6rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 40px;
        }

        .auth-btn:hover {
            background: rgba(243, 156, 18, 1);
            border-color: #f39c12;
            transform: translateY(-1px);
        }

        .expand-toggle {
            cursor: pointer;
            transition: transform 0.2s ease;
            opacity: 0.6;
            font-size: 0.8rem;
        }

        .expand-toggle:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .company-section.expanded .expand-toggle {
            transform: rotate(180deg);
        }

        .company-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .company-section.expanded .company-content {
            max-height: 2000px;
        }

        /* Status-based stat styling */
        .stat-item.up .stat-value {
            color: #27ae60;
        }

        .stat-item.warning .stat-value {
            color: #f39c12;
        }

        .stat-item.down .stat-value {
            color: #e74c3c;
        }

        /* Device Detail Modal */
        .device-detail-modal {
            position: fixed;
            top: 0;
            right: -600px;
            width: 600px;
            height: 100vh;
            background: linear-gradient(135deg, rgba(20, 30, 48, 0.95), rgba(30, 60, 114, 0.95));
            backdrop-filter: blur(15px);
            border-left: 2px solid rgba(52, 152, 219, 0.3);
            transition: right 0.3s ease-in-out;
            z-index: 1000;
            overflow-y: auto;
        }

        .device-detail-modal.open {
            right: 0;
        }

        .detail-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #3498db;
        }

        .close-detail {
            background: none;
            border: none;
            color: #bdc3c7;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-detail:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .detail-content {
            padding: 1.5rem;
        }

        .detail-section {
            margin-bottom: 2rem;
        }

        .detail-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #e74c3c;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(231, 76, 60, 0.2);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .detail-label {
            color: #95a5a6;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            color: #fff;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .sensor-list {
            display: grid;
            gap: 0.5rem;
        }

        .sensor-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 0.75rem;
            border-left: 3px solid;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sensor-item:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .sensor-item.up { border-left-color: #27ae60; }
        .sensor-item.down { border-left-color: #e74c3c; }
        .sensor-item.warning { border-left-color: #f39c12; }
        .sensor-item.paused { border-left-color: #95a5a6; }
        .sensor-item.unusual { border-left-color: #9b59b6; }

        .sensor-name {
            font-weight: 600;
            color: #fff;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .sensor-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sensor-type {
            color: #7f8c8d;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .sensor-value {
            color: #3498db;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .alert-list {
            display: grid;
            gap: 0.5rem;
        }

        .alert-item {
            background: rgba(231, 76, 60, 0.1);
            border-radius: 6px;
            padding: 0.75rem;
            border-left: 3px solid #e74c3c;
        }

        .alert-time {
            color: #95a5a6;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .alert-message {
            color: #fff;
            font-size: 0.85rem;
        }

        .loading-detail {
            text-align: center;
            padding: 2rem;
            color: #95a5a6;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-backdrop.open {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body>
    <div class="startup-progress-overlay" id="startupProgressOverlay">
        <div class="startup-progress-card">
            <div class="startup-progress-title">
                <i class="fas fa-server"></i>
                Initializing Dashboard Services
            </div>
            <div class="spinner-container">
                <div class="spinner-ball"></div>
                <div class="spinner-ball"></div>
                <div class="spinner-ball"></div>
            </div>
            <div class="startup-progress-message" id="startupProgressMessage">Initializing dashboard services (this may take a while, please be patient)</div>
            <div class="startup-progress-bar">
                <div class="startup-progress-fill" id="startupProgressFill"></div>
            </div>
            <div class="startup-progress-percent" id="startupProgressPercent">0%</div>
        </div>
    </div>
    <div class="header">
        <!-- Top Row: Logo + Title + Actions -->
        <div class="header-top">
            <div class="header-brand">
                <a href="/" style="display: flex; align-items: center; text-decoration: none;">
                    <img src="images/controlpoint-logo.svg" alt="ControlPoint MONITOR" class="controlpoint-logo">
                </a>
                <div class="brand-text">
                    <h1>LANAIR Unified Monitoring</h1>
                    <div class="header-subtitle">Network Infrastructure Intelligence</div>
                </div>
            </div>
            
            <div class="header-actions">
                <div class="connection-status">
                    <div class="connection-indicator" id="connectionIndicator"></div>
                    <span id="connectionText">Connecting...</span>
                </div>
                <div class="session-expiry-flag" id="sessionExpiryFlag" title="Session timer - refreshes from server every 10 minutes. Timer counts down in real-time.">
                    <i class="fas fa-hourglass-half"></i>
                    <span id="sessionExpiryText">Session: 00:00</span>
                </div>
                <div class="admin-quick-menu" id="adminQuickMenu" style="display: none;">
                    <button class="admin-portal-btn" id="adminPortalBtn" title="Admin shortcuts" onclick="toggleAdminQuickMenu(event)">
                        <i class="fas fa-shield-alt"></i>
                    </button>
                    <div class="admin-quick-dropdown" id="adminQuickDropdown">
                        <a href="/admin" class="admin-link"><i class="fas fa-toolbox"></i> Admin Console</a>
                        <a href="/admin/sessions.html" class="admin-link"><i class="fas fa-users-gear"></i> Session Intelligence</a>
                        <a href="/admin/telemetry.html" class="admin-link"><i class="fas fa-chart-line"></i> Telemetry Overview</a>
                    </div>
                </div>
                <div class="user-menu-container">
                    <button class="user-menu-btn" onclick="toggleUserMenu()" title="User Menu">
                        <i class="fas fa-user-circle"></i>
                        <span class="username-display" id="usernameDisplay">Guest</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-menu-dropdown" id="userMenuDropdown">
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div class="user-details">
                                <div class="user-name" id="userNameMenu">Guest User</div>
                                <div class="user-role" id="userRoleBadge">Standard User</div>
                            </div>
                        </div>
                        <div class="menu-separator"></div>
                        <button class="menu-item" onclick="handleChangePassword()">
                            <i class="fas fa-lock"></i>
                            Change Password
                        </button>
                        <button class="menu-item" onclick="handleSessionInfo()">
                            <i class="fas fa-info-circle"></i>
                            Session Info
                        </button>
                        <div class="menu-separator admin-only" id="adminMenuSeparator" style="display: none;"></div>
                        <button class="menu-item admin-only" id="adminDashboardLink" style="display: none;" onclick="navigateToAdmin('/admin')">
                            <i class="fas fa-toolbox"></i>
                            Admin Console
                        </button>
                        <button class="menu-item admin-only" id="adminSessionsLink" style="display: none;" onclick="navigateToAdmin('/admin/sessions.html')">
                            <i class="fas fa-users-gear"></i>
                            Session Intelligence
                        </button>
                        <button class="menu-item admin-only" id="adminTelemetryLink" style="display: none;" onclick="navigateToAdmin('/admin/telemetry.html')">
                            <i class="fas fa-chart-line"></i>
                            Telemetry Overview
                        </button>
                        <div class="menu-separator"></div>
                        <button class="menu-item logout" onclick="handleLogout()" style="
                            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                            border: none;
                            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(231, 76, 60, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(231, 76, 60, 0.3)';">
                            <i class="fas fa-sign-out-alt"></i>
                            Logout
                        </button>
                    </div>
                </div>
                <button class="auth-btn" onclick="dashboard.promptForCredentials()" title="Enhanced Data Access">
                    <i class="fas fa-key"></i>
                </button>
                <button class="refresh-btn" onclick="handleRefresh()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Middle Row: Telemetry Bar -->
        <div class="telemetry-bar">
            <div class="telemetry-indicators">
                <div class="telemetry-item">
                    <div class="telemetry-pulse"></div>
                    <span class="telemetry-count" id="totalDevicesHeader">920</span>
                    <span class="telemetry-label">Devices</span>
                </div>
                <div class="telemetry-separator"></div>
                <div class="telemetry-item critical">
                    <div class="telemetry-alert-icon">âš </div>
                    <span class="telemetry-count" id="criticalAlertsHeader">0</span>
                </div>
                <div class="telemetry-item warning">
                    <div class="telemetry-warning-icon">âš¡</div>
                    <span class="telemetry-count" id="warningAlertsHeader">0</span>
                </div>
                <div class="telemetry-item success">
                    <div class="telemetry-health-bar">
                        <div class="health-fill" id="healthBar"></div>
                    </div>
                    <span class="telemetry-count" id="healthyDevicesHeader">858</span>
                </div>
            </div>
            
            <div class="header-controls">
                <input type="text" class="search-box" placeholder="Search devices, companies..." id="searchBox">
                <select class="filter-select" id="statusFilter">
                    <option value="all">All Status</option>
                    <option value="up">Up</option>
                    <option value="down">Down</option>
                    <option value="warning">Warning</option>
                </select>
                <select class="filter-select" id="companyFilter">
                    <option value="all">All Companies</option>
                </select>
            </div>
        </div>
        
        <!-- Bottom Row: Navigation -->
        <nav class="header-nav">
            <div class="nav-item active" onclick="switchView('overview')">
                <i class="fas fa-tachometer-alt"></i>
                <span>Overview</span>
            </div>
            <div class="nav-item" onclick="switchView('topology')">
                <i class="fas fa-project-diagram"></i>
                <span>Topology</span>
            </div>
            <div class="nav-item" onclick="switchView('alerts')">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Alerts</span>
            </div>
            <div class="nav-item" onclick="switchView('analytics')">
                <i class="fas fa-chart-line"></i>
                <span>Analytics</span>
            </div>
            <div class="nav-item" onclick="switchView('reports')">
                <i class="fas fa-file-alt"></i>
                <span>Reports</span>
            </div>
            <div class="nav-item external-link" onclick="window.open('https://cva.lanairgroup.com', '_blank')" style="margin-left: auto; border-left: 1px solid rgba(255,255,255,0.1); padding-left: 2rem; cursor: pointer;" title="Go to CVE Vulnerability Analyzer (opens in new tab)">
                <i class="fas fa-shield-alt"></i>
                <span>CVE Analyzer</span>
                <i class="fas fa-external-link-alt" style="font-size: 0.75rem; opacity: 0.7; margin-left: 0.25rem;"></i>
            </div>
        </nav>
    </div>

    <div class="main-content">
        <div class="overview-stats" id="overviewStats">
            <!-- Stats will be populated by JavaScript -->
        </div>

        <div class="companies-grid" id="companiesGrid">
            <div class="loading">Loading company data</div>
        </div>

        <div class="last-update" id="lastUpdate">
            Last updated: <span id="updateTime">Never</span>
        </div>
    </div>

    <script>
    let adminQuickOutsideHandler = null;

    async function fetchSystemProgress() {
            try {
                const res = await fetch('/api/system/progress', { credentials: 'include' });
                if (!res.ok) return null;
                return await res.json();
            } catch (error) {
                console.debug('Failed to fetch system progress', error);
                return null;
            }
        }

        async function monitorStartupProgress() {
            const overlay = document.getElementById('startupProgressOverlay');
            const fill = document.getElementById('startupProgressFill');
            const messageEl = document.getElementById('startupProgressMessage');
            const percentEl = document.getElementById('startupProgressPercent');
            if (!overlay || !fill || !messageEl || !percentEl) {
                return;
            }

            const showOverlay = () => {
                if (!overlay.classList.contains('visible')) {
                    overlay.style.display = 'flex';
                    requestAnimationFrame(() => overlay.classList.add('visible'));
                }
            };

            const hideOverlay = () => {
                if (overlay.classList.contains('visible')) {
                    overlay.classList.remove('visible');
                    setTimeout(() => {
                        if (!overlay.classList.contains('visible')) {
                            overlay.style.display = 'none';
                        }
                    }, 350);
                }
            };

            let consecutiveReady = 0;

            const applyState = (state) => {
                const rawPercent = typeof state?.percentage === 'number' ? state.percentage : 0;
                const percent = Math.max(0, Math.min(100, Math.round(rawPercent)));
                fill.style.width = `${percent}%`;
                percentEl.textContent = `${percent}%`;
                if (state?.message) {
                    messageEl.textContent = state.message;
                }

                const shouldHide = state?.ready === true || percent >= 100;
                if (shouldHide) {
                    hideOverlay();
                } else {
                    showOverlay();
                }

                if (shouldHide) {
                    consecutiveReady += 1;
                } else {
                    consecutiveReady = 0;
                }

                return consecutiveReady >= 2;
            };

            const poll = async () => {
                const state = await fetchSystemProgress();
                if (!state) {
                    showOverlay();
                    messageEl.textContent = 'Waiting for backend warm-upâ€¦';
                    fill.style.width = '0%';
                    percentEl.textContent = '0%';
                    consecutiveReady = 0;
                    return false;
                }
                return applyState(state);
            };

            const initialComplete = await poll();
            if (initialComplete) {
                return;
            }

            const intervalId = setInterval(async () => {
                const complete = await poll();
                if (complete) {
                    clearInterval(intervalId);
                }
            }, 4000);
        }

    function setAdminMenuVisibility(isAdmin) {
            const separator = document.getElementById('adminMenuSeparator');
            const dashboardLink = document.getElementById('adminDashboardLink');
            const sessionsLink = document.getElementById('adminSessionsLink');
            const telemetryLink = document.getElementById('adminTelemetryLink');
            const quickMenu = document.getElementById('adminQuickMenu');
            const displayMap = isAdmin ? { separator: 'block', link: 'flex' } : { separator: 'none', link: 'none' };
            if (separator) separator.style.display = displayMap.separator;
            if (dashboardLink) dashboardLink.style.display = displayMap.link;
            if (sessionsLink) sessionsLink.style.display = displayMap.link;
            if (telemetryLink) telemetryLink.style.display = displayMap.link;
            if (quickMenu) {
                quickMenu.style.display = isAdmin ? 'block' : 'none';
                if (!isAdmin) closeAdminQuickMenu();
            }
        }

        function applySessionContext(context = {}) {
            const username = context.username || 'Guest';
            const role = (context.role || 'user').toLowerCase();
            const usernameDisplay = document.getElementById('usernameDisplay');
            const userNameMenu = document.getElementById('userNameMenu');
            const roleBadge = document.getElementById('userRoleBadge');
            if (usernameDisplay) usernameDisplay.textContent = username;
            if (userNameMenu) userNameMenu.textContent = username;
            if (roleBadge) roleBadge.textContent = role === 'admin' ? 'Administrator' : 'Standard User';
            setAdminMenuVisibility(role === 'admin');
        }

        async function syncSessionContext() {
            try {
                const res = await fetch('/api/session/status', { credentials: 'include' });
                if (!res.ok) {
                    console.debug('Session status endpoint not available (404)');
                    return null;
                }
                const data = await res.json();
                applySessionContext({ username: data.username, role: data.role });
                if (window.securityManager && data.authenticated && typeof window.securityManager.applyServerSession === 'function') {
                    window.securityManager.applyServerSession(data);
                }
                return data;
            } catch (error) {
                console.debug('Failed to synchronise session context', error);
                return null;
            }
        }

        // Authentication Manager for Dynamic API Access
        class AuthManager {
            constructor() {
                this.credentials = null;
                this.authHeaders = {};
                this.sessionToken = null;
                this.authType = 'session'; // 'session', 'basic', 'bearer'
            }
            
            setCredentials(username, password) {
                this.credentials = { username, password };
                // Create basic auth header for direct API calls
                const basicAuth = btoa(`${username}:${password}`);
                this.authHeaders = {
                    'Authorization': `Basic ${basicAuth}`,
                    'Content-Type': 'application/json'
                };
                return this;
            }
            
            setSessionToken(token) {
                this.sessionToken = token;
                this.authHeaders = {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                };
                this.authType = 'bearer';
                return this;
            }
            
            getAuthHeaders() {
                return { ...this.authHeaders };
            }
            
            async authenticatedFetch(url, options = {}) {
                const authOptions = {
                    ...options,
                    credentials: 'include', // Include session cookies
                    headers: {
                        ...options.headers
                    }
                };
                
                // Add auth headers if we have credentials (for backup)
                if (this.credentials || this.sessionToken) {
                    authOptions.headers = {
                        ...this.getAuthHeaders(),
                        ...authOptions.headers
                    };
                }
                
                try {
                    const response = await fetch(url, authOptions);
                    
                    // Handle authentication redirects
                    if (response.status === 302 && response.headers.get('location')?.includes('/login')) {
                        console.debug('Authentication required for:', url);
                        return { ok: false, status: 401, statusText: 'Authentication Required' };
                    }
                    
                    return response;
                } catch (error) {
                    console.error('Authenticated fetch error:', error);
                    throw error;
                }
            }
        }

        // Enterprise Security Manager
        class SecurityManager {
            constructor() {
                this.sessionTimeout = 30 * 60 * 1000; // default fallback
                this.sessionWarningTime = 5 * 60 * 1000; // warn 5 minutes before expiry by default
                this.sessionTimer = null;
                this.warningTimer = null;
                this.currentUser = null;
                this.loginTime = null;
                this.lastActivity = Date.now();
                this.isLocked = false;
                this.sessionExpiry = null;
                this.activityTrackingBound = false;
                
                this.initializeSessionPromise = this.initializeSession();
            }

            async initializeSession() {
                const serverSession = await this.syncWithServer();
                if (serverSession) {
                    this.ensureActivityTracking();
                    return;
                }

                const stored = this.getStoredSession();
                if (stored && this.isValidSession(stored)) {
                    this.restoreSession(stored);
                    this.ensureActivityTracking();
                    return;
                }

                this.clearSession();
                // Don't call requireAuthentication here - SOCDashboard will handle it
                console.debug('SecurityManager: No valid session found, dashboard will handle authentication');
            }

            ensureActivityTracking() {
                if (!this.activityTrackingBound) {
                    this.setupActivityTracking();
                    this.activityTrackingBound = true;
                }
            }

            async syncWithServer() {
                try {
                    const response = await fetch('/api/session/status', { credentials: 'include' });
                    if (!response.ok) {
                        // Endpoint doesn't exist yet, fail silently
                        console.debug('Session status endpoint not available (404)');
                        return null;
                    }
                    const data = await response.json();
                    if (data && data.authenticated) {
                        this.applyServerSession(data);
                        return data;
                    }
                } catch (error) {
                    console.debug('Session sync error (expected if endpoint not implemented):', error.message);
                    console.debug('Server session sync failed:', error);
                }
                return null;
            }

            applyServerSession(data) {
                if (!data || !data.authenticated) return;
                const normalizedRole = (data.role || 'user').toLowerCase();
                const loginTime = data.loginTime ? Date.parse(data.loginTime) : Date.now();
                const timeLeftMs = typeof data.timeLeftMs === 'number' ? data.timeLeftMs : null;
                const sessionExpiry = timeLeftMs !== null ? Date.now() + timeLeftMs : null;

                const sessionData = {
                    username: data.username || 'User',
                    role: normalizedRole,
                    sessionId: data.edrSessionId || null,
                    loginTime,
                    expiry: sessionExpiry
                };

                this.currentUser = sessionData;
                this.loginTime = loginTime;
                this.sessionExpiry = sessionExpiry;
                this.saveSession(sessionData);
                this.updateUserDisplay();
                this.startSessionTimerFromServer(timeLeftMs);

                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    mainContent.style.display = 'block';
                }
            }

            startSessionTimerFromServer(timeLeftMs) {
                if (typeof timeLeftMs === 'number' && timeLeftMs > 0) {
                    this.sessionTimeout = timeLeftMs;
                    const defaultWarning = 5 * 60 * 1000;
                    const calculatedWarning = Math.min(defaultWarning, Math.max(Math.floor(timeLeftMs * 0.1), 60 * 1000));
                    this.sessionWarningTime = timeLeftMs > defaultWarning ? defaultWarning : calculatedWarning;
                    if (this.sessionWarningTime >= this.sessionTimeout) {
                        this.sessionWarningTime = Math.max(Math.floor(this.sessionTimeout / 3), 60 * 1000);
                    }
                } else if (this.sessionExpiry) {
                    const remaining = this.sessionExpiry - Date.now();
                    if (remaining > 0) {
                        this.sessionTimeout = remaining;
                    }
                }

                this.startSessionTimer();
            }

            redirectToLogin(targetUrl = null) {
                const fallback = '/login?next=' + encodeURIComponent(window.location.pathname + window.location.search);
                const destination = (typeof targetUrl === 'string' && targetUrl.length > 0) ? targetUrl : fallback;
                window.location.href = destination;
            }

            setupActivityTracking() {
                const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
                activityEvents.forEach(event => {
                    document.addEventListener(event, () => {
                        this.updateActivity();
                    }, true);
                });
            }

            updateActivity() {
                this.lastActivity = Date.now();
                if (this.sessionTimer) {
                    this.resetSessionTimer();
                }
            }

            login(username, password, context = {}) {
                const sessionData = {
                    username: username,
                    loginTime: Date.now(),
                    sessionId: context.sessionId || this.generateSessionId(),
                    role: (context.role || 'user').toLowerCase()
                };

                if (context.remember) {
                    sessionData.extendedSession = true;
                    sessionData.password = password;
                }

                this.currentUser = sessionData;
                this.loginTime = sessionData.loginTime;
                this.lastActivity = Date.now();

                this.saveSession(sessionData);
                this.updateUserDisplay();
                this.startSessionTimer();

                return sessionData;
            }

            logout() {
                try {
                    // Force logout immediately without confirmation
                    this.forceLogout('User logged out');
                } catch (error) {
                    console.error('Error in logout():', error);
                    // Fallback: force logout
                    this.forceLogout('User logged out');
                }
            }

            async forceLogout(reason = 'Session expired') {
                console.log('ðŸšª LOGOUT INITIATED:', reason);
                
                // Show loading spinner immediately
                const spinner = document.createElement('div');
                spinner.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                                background: rgba(0,0,0,0.7); z-index: 999999; 
                                display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 2rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 1rem;">ðŸšª</div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;">Logging out...</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(spinner.firstElementChild);
                
                let redirectTarget = null;
                let logoutSuccess = false;
                
                try {
                    console.log('ðŸ“¡ Sending logout request to backend...');
                    const response = await fetch('/logout', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });

                    console.log('ðŸ“¡ Logout response status:', response.status);

                    if (response) {
                        if (response.ok) {
                            logoutSuccess = true;
                            const contentType = response.headers.get('content-type') || '';
                            if (contentType.includes('application/json')) {
                                try {
                                    const payload = await response.json();
                                    console.log('âœ… Logout response:', payload);
                                    if (payload?.redirect) {
                                        redirectTarget = payload.redirect;
                                    }
                                } catch (parseError) {
                                    console.warn('âš ï¸ Logout response parse failed', parseError);
                                }
                            } else if (response.redirected && response.url) {
                                redirectTarget = response.url;
                            }
                        } else {
                            console.error('âŒ Logout failed with status:', response.status);
                            if (response.status >= 300 && response.status < 400 && response.url) {
                                redirectTarget = response.url;
                            }
                        }
                    }
                } catch (error) {
                    console.error('âŒ Error during logout request:', error);
                }

                // Clear cookies client-side as well
                console.log('ðŸª Clearing client-side cookies...');
                document.cookie.split(";").forEach(function(c) { 
                    const cookieName = c.trim().split("=")[0];
                    if (cookieName === 'connect.sid' || cookieName === 'edr.sid') {
                        document.cookie = cookieName + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';
                        console.log('ðŸª Cleared cookie:', cookieName);
                    }
                });

                // Clear all session data
                console.log('ðŸ—‘ï¸ Clearing session data...');
                this.clearSession();
                
                // Clear authentication manager
                if (window.dashboard && window.dashboard.authManager) {
                    window.dashboard.authManager.credentials = null;
                    window.dashboard.authManager.authHeaders = {};
                    window.dashboard.authManager.sessionToken = null;
                }
                
                // Clear any existing modals first
                const modals = document.querySelectorAll('.security-modal');
                modals.forEach(modal => modal.remove());
                
                // Hide main content
                const mainContent = document.querySelector('.main-content');
                if (mainContent) mainContent.style.display = 'none';
                
                console.log('âœ… Logout complete, redirecting...');
                // Show brief goodbye message then redirect to login
                this.showBriefGoodbyeThenLogin(reason, redirectTarget);
            }

            async validateSessionWithBackend() {
                try {
                    const response = await fetch('/api/session/status', { credentials: 'include' });
                    if (!response.ok) {
                        return { valid: false, reason: 'Status request failed' };
                    }
                    const data = await response.json();
                    if (data && data.authenticated) {
                        this.applyServerSession(data);
                        return { valid: true, data };
                    }
                    return { valid: false, reason: 'Session not authenticated' };
                } catch (error) {
                    console.error('Backend session validation error:', error);
                    return { valid: false, reason: 'Validation error' };
                }
            }

            async getSessionInfo() {
                try {
                    const response = await fetch('/api/session/details', { credentials: 'include' });
                    if (!response.ok) {
                        throw new Error('Failed to fetch session info');
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Failed to get session info:', error);
                    throw error;
                }
            }

            returnToLogin() {
                // Clear any existing modals
                const modals = document.querySelectorAll('.security-modal');
                modals.forEach(modal => modal.remove());
                
                this.redirectToLogin();
            }

            clearSession() {
                this.saveSession(null);
                sessionStorage.clear();
                this.currentUser = null;
                this.loginTime = null;
                
                if (this.sessionTimer) clearTimeout(this.sessionTimer);
                if (this.warningTimer) clearTimeout(this.warningTimer);
            }

            isValidSession(session) {
                const now = Date.now();
                const sessionAge = now - session.loginTime;
                return sessionAge < this.sessionTimeout;
            }

            restoreSession(session) {
                const normalized = {
                    ...session,
                    role: (session.role || 'user').toLowerCase()
                };
                this.currentUser = normalized;
                this.loginTime = normalized.loginTime;
                this.sessionExpiry = normalized.expiry || null;
                if (this.sessionExpiry) {
                    const remaining = this.sessionExpiry - Date.now();
                    if (remaining > 0) {
                        this.sessionTimeout = remaining;
                    }
                }
                this.saveSession(normalized);
                this.updateUserDisplay();
                this.startSessionTimer();
            }

            startSessionTimer() {
                // Clear existing timers
                if (this.sessionTimer) clearTimeout(this.sessionTimer);
                if (this.warningTimer) clearTimeout(this.warningTimer);

                const timeoutMs = Math.max(0, this.sessionTimeout || 0);
                if (timeoutMs === 0) {
                    return;
                }

                const warningLead = Math.max(0, Math.min(this.sessionWarningTime, timeoutMs));
                const warningDelay = Math.max(0, timeoutMs - warningLead);

                if (warningDelay > 0) {
                    this.warningTimer = setTimeout(() => {
                        this.showSessionWarning();
                    }, warningDelay);
                }

                this.sessionTimer = setTimeout(() => {
                    this.forceLogout('Session timeout');
                }, timeoutMs);
            }

            resetSessionTimer() {
                this.startSessionTimer();
            }

            generateSessionId() {
                return 'sess_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            }

            saveSession(session) {
                try {
                    if (session) {
                        localStorage.setItem('securitySession', JSON.stringify(session));
                    } else {
                        localStorage.removeItem('securitySession');
                    }
                } catch (error) {
                    console.warn('Unable to persist security session', error);
                }
            }

            getStoredSession() {
                try {
                    const raw = localStorage.getItem('securitySession');
                    return raw ? JSON.parse(raw) : null;
                } catch (error) {
                    console.warn('Unable to parse stored security session', error);
                    return null;
                }
            }

            setRole(role = 'user') {
                const targetRole = (role || 'user').toLowerCase();
                const stored = this.getStoredSession() || {};
                const merged = {
                    ...stored,
                    ...(this.currentUser || {}),
                    role: targetRole
                };
                this.currentUser = merged;
                this.saveSession(merged);
                this.updateUserDisplay();
            }

            setSessionId(sessionId) {
                if (!sessionId) return;
                const stored = this.getStoredSession() || {};
                const merged = {
                    ...stored,
                    ...(this.currentUser || {}),
                    sessionId
                };
                if (!merged.loginTime) merged.loginTime = Date.now();
                if (!merged.role) merged.role = 'user';
                this.currentUser = merged;
                this.saveSession(merged);
            }

            updateUserDisplay() {
                if (this.currentUser) {
                    applySessionContext({
                        username: this.currentUser.username,
                        role: this.currentUser.role
                    });
                } else {
                    applySessionContext({ username: 'Guest', role: 'user' });
                }
            }

            showSessionWarning() {
                const modal = this.createModal('Session Warning', `
                    <div style="text-align: center; padding: 1rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f39c12; margin-bottom: 1rem;"></i>
                        <h3>Your session will expire in 5 minutes</h3>
                        <p>Click "Extend Session" to continue working, or "Logout" to end your session now.</p>
                        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center;">
                            <button onclick="securityManager.extendSession(); closeModal()" style="background: #27ae60; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">
                                Extend Session
                            </button>
                            <button onclick="securityManager.forceLogout('User logged out'); closeModal()" style="background: #e74c3c; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">
                                Logout Now
                            </button>
                        </div>
                    </div>
                `, true);
            }

            extendSession() {
                this.lastActivity = Date.now();
                this.syncWithServer().then((data) => {
                    if (!data) {
                        this.resetSessionTimer();
                    }
                });
            }

            showLogoutConfirm() {
                try {
                    // Clear any existing modals first
                    const existingModals = document.querySelectorAll('.security-modal');
                    existingModals.forEach(modal => modal.remove());
                    
                    const modal = this.createModal('Confirm Logout', `
                    <div style="text-align: center; padding: 1rem;">
                        <i class="fas fa-sign-out-alt" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                        <h3>Are you sure you want to logout?</h3>
                        <p>You will need to re-authenticate to access the dashboard.</p>
                        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center;">
                            <button onclick="closeModal()" style="background: #95a5a6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="securityManager.forceLogout('User logged out'); closeModal()" style="background: #e74c3c; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">
                                Logout
                            </button>
                        </div>
                    </div>
                `, true);
                } catch (error) {
                    console.error('Error creating logout modal:', error);
                    // Fallback: use browser confirm
                    if (confirm('Are you sure you want to logout?')) {
                        this.forceLogout('User logged out');
                    }
                }
            }

            showLogoutMessage(reason) {
                this.showGoodbyePage(reason);
            }

            showGoodbyePage(reason = 'Logout successful') {
                const modal = this.createModal('Goodbye', `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="margin-bottom: 2rem;">
                            <img src="https://www.lanairgroup.com/wp-content/uploads/2023/05/ControlPoint-MONITOR-Logo.png" alt="ControlPoint MONITOR" style="max-width: 200px; height: auto; margin-bottom: 1rem;">
                        </div>
                        <i class="fas fa-check-circle" style="font-size: 4rem; color: #27ae60; margin-bottom: 1.5rem;"></i>
                        <h2 style="color: #2c3e50; margin-bottom: 1rem;">Thank You!</h2>
                        <h3 style="color: #34495e; margin-bottom: 1.5rem;">${reason}</h3>
                        <p style="color: #7f8c8d; margin-bottom: 2rem; line-height: 1.6;">
                            Your session has been securely ended. Thank you for using the LANAIR Unified Monitoring Dashboard.
                        </p>
                        <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                            <p style="margin: 0; color: #495057; font-size: 0.9rem;">
                                <i class="fas fa-shield-alt" style="color: #28a745; margin-right: 0.5rem;"></i>
                                Your data remains secure and all session information has been cleared.
                            </p>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button onclick="securityManager.returnToLogin()" style="
                                background: linear-gradient(135deg, #007bff, #0056b3); 
                                color: white; 
                                border: none; 
                                padding: 0.75rem 2rem; 
                                border-radius: 8px; 
                                cursor: pointer; 
                                font-weight: bold;
                                box-shadow: 0 4px 12px rgba(0,123,255,0.3);
                                transition: all 0.3s ease;
                            " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <i class="fas fa-sign-in-alt" style="margin-right: 0.5rem;"></i>
                                Login Again
                            </button>
                            <button onclick="window.close()" style="
                                background: linear-gradient(135deg, #6c757d, #495057); 
                                color: white; 
                                border: none; 
                                padding: 0.75rem 2rem; 
                                border-radius: 8px; 
                                cursor: pointer; 
                                font-weight: bold;
                                box-shadow: 0 4px 12px rgba(108,117,125,0.3);
                                transition: all 0.3s ease;
                            " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                                Close Window
                            </button>
                        </div>
                        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.2);">
                            <p style="margin: 0; color: #95a5a6; font-size: 0.8rem;">
                                LANAIR Unified Monitoring Dashboard â€¢ ControlPoint MONITOR<br>
                                Secure Enterprise Network Monitoring Solution
                            </p>
                        </div>
                    </div>
                `, false);
                
                // Make the modal non-dismissible by clicking outside
                const backdrop = modal.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.style.pointerEvents = 'none';
                    backdrop.querySelector('.modal-content').style.pointerEvents = 'all';
                }
            }

            showBriefGoodbyeThenLogin(reason = 'Logout successful', redirectUrl = null) {
                // Show a brief success message
                const modal = this.createModal('Logged Out', `
                    <div style="text-align: center; padding: 1.5rem;">
                        <i class="fas fa-check-circle" style="font-size: 3rem; color: #27ae60; margin-bottom: 1rem;"></i>
                        <h3 style="color: #2c3e50; margin-bottom: 0.5rem;">Logout Complete</h3>
                        <p style="color: #7f8c8d; margin-bottom: 1rem;">${reason}</p>
                        <p style="color: #95a5a6; font-size: 0.9rem;">Redirecting to login...</p>
                    </div>
                `, false);
                
                // Auto-redirect to login after 2 seconds
                setTimeout(() => {
                    this.redirectToLogin(redirectUrl);
                }, 2000);
            }

            createModal(title, content, showCloseButton = true) {
                const modal = document.createElement('div');
                modal.className = 'security-modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 99999; display: block !important;';
                modal.innerHTML = `
                    <div class="modal-backdrop">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>${title}</h3>
                                ${showCloseButton ? '<button onclick="closeModal()" style="background: none; border: none; color: #95a5a6; font-size: 1.5rem; cursor: pointer;">&times;</button>' : ''}
                            </div>
                            <div class="modal-body">
                                ${content}
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                return modal;
            }
        }

        class SOCDashboard {
            constructor() {
                this.companies = new Map();
                this.devices = [];
                this.maxDeviceCountEverSeen = 0; // NEVER allow device count to regress below this
                this.filters = {
                    search: '',
                    status: 'all',
                    company: 'all'
                };
                this.ws = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectInterval = 5000;
                this.isLoading = false; // Prevent concurrent data loads
                this.initialLoadComplete = false; // Prevent triggers before initial load finishes
                this.webSocketDisabled = false;
                this.authManager = new AuthManager();
                this.dataLoaded = false;

                this.init();
            }

            async init() {
                // Show loading state immediately
                this.showInitialLoadingState();
                
                this.setupEventListeners();

                // Small delay to ensure cookies are fully processed after cross-domain navigation
                await new Promise(resolve => setTimeout(resolve, 300));

                if (window.securityManager?.initializeSessionPromise) {
                    try {
                        await window.securityManager.initializeSessionPromise;
                    } catch (error) {
                        console.debug('Security manager failed to initialize before dashboard boot', error);
                    }
                }
                
                // Check if authentication is needed and prompt if necessary
                await this.initializeAuthentication();
                
                // Only connect WebSocket after authentication is verified
                this.connectWebSocket();
                
                // Wait for data to fully load before showing
                await this.loadData();
                this.dataLoaded = true;
                this.initialLoadComplete = true; // Mark initial load as complete
                this.startAutoRefresh();
            }
            
            showInitialLoadingState() {
                const companiesGrid = document.getElementById('companiesGrid');
                if (companiesGrid) {
                    companiesGrid.innerHTML = `
                        <div class="loading" style="padding: 4rem; text-align: center;">
                            <div style="margin-bottom: 1.5rem;">
                                <i class="fas fa-spinner fa-pulse" style="font-size: 3rem; color: #3498db;"></i>
                            </div>
                            <div style="font-size: 1.2rem; color: #bdc3c7; margin-bottom: 0.5rem;">
                                Loading Network Infrastructure...
                            </div>
                            <div style="font-size: 0.9rem; color: #7f8c8d;">
                                Retrieving devices from all locations
                            </div>
                        </div>
                    `;
                }
                
                const overviewStats = document.getElementById('overviewStats');
                if (overviewStats) {
                    overviewStats.innerHTML = `
                        <div class="stat-card total" style="grid-column: 1 / -1;">
                            <div class="stat-number"><i class="fas fa-spinner fa-spin"></i></div>
                            <div class="stat-label">Initializing dashboard services (this may take a while, please be patient)</div>
                        </div>
                    `;
                }
            }
            
            async initializeAuthentication() {
                try {
                    const securityManager = window.securityManager;

                    if (securityManager?.initializeSessionPromise) {
                        await securityManager.initializeSessionPromise.catch(error => {
                            console.debug('Security manager initialization reported an error', error);
                        });
                    }

                    const status = await syncSessionContext();
                    const serverAuthenticated = status?.authenticated === true;

                    const storedSession = securityManager?.currentUser || securityManager?.getStoredSession?.();
                    const storedValid = storedSession && securityManager?.isValidSession?.(storedSession);

                    if (serverAuthenticated) {
                        this.handleAuthenticatedState({ username: status?.username, role: status?.role });
                        return;
                    }

                    if (storedValid) {
                        try {
                            // Add 30-second timeout for validation (increased from 5s to handle slow queries)
                            const timeoutPromise = new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Validation timeout')), 30000)
                            );
                            const fetchPromise = this.authManager.authenticatedFetch('/api/devices/enhanced?limit=1');
                            const validationResponse = await Promise.race([fetchPromise, timeoutPromise]);
                            
                            if (validationResponse?.ok) {
                                securityManager.restoreSession?.(storedSession);
                                this.handleAuthenticatedState({ username: storedSession.username, role: storedSession.role });
                                return;
                            }
                            console.debug('Stored session validation failed with status', validationResponse?.status);
                        } catch (error) {
                            console.debug('Stored session validation error', error);
                        }
                    }
                } catch (error) {
                    console.debug('Authentication initialisation encountered an error', error);
                }

                // No valid session present - force login
                this.requireAuthentication();
            }

            handleAuthenticatedState(sessionInfo = {}) {
                this.updateAuthButtonState(true);
                this.showMainContent();
                if (sessionInfo.username || sessionInfo.role) {
                    applySessionContext(sessionInfo);
                }
                this.updateConnectionStatus('connected', 'Authenticated & Connected');
            }

            showMainContent() {
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    mainContent.style.display = 'block';
                    mainContent.classList.add('authenticated');
                }
            }

            /**
             * Redirect user to login page with post-login return URL
             * @param {string|null} targetUrl - Optional specific URL to redirect to after login
             * @description Handles authentication redirects. Preserves current URL in 'next' parameter
             *              so user returns to original page after successful login.
             * @added v8.1 - Duplicated from SecurityManager to resolve cross-class method call
             */
            redirectToLogin(targetUrl = null) {
                const fallback = '/login?next=' + encodeURIComponent(window.location.pathname + window.location.search);
                const destination = (typeof targetUrl === 'string' && targetUrl.length > 0) ? targetUrl : fallback;
                window.location.href = destination;
            }

            /**
             * Require authentication and redirect if not authenticated
             * @description Called when protected operations need authentication.
             *              Hides main content and redirects to login page.
             * @security Ensures sensitive data not visible during redirect
             */
            requireAuthentication() {
                // Hide main content immediately to prevent data exposure
                const mainContent = document.querySelector('.main-content');
                if (mainContent) mainContent.style.display = 'none';
                
                // Redirect to centralized login experience
                this.redirectToLogin();
            }
            
            showAuthenticationScreen() {
                this.redirectToLogin();
            }

            async handleAuthentication() {
                this.redirectToLogin();
                return false;
            }

            showAuthError(message) {
                const authError = document.getElementById('authError');
                if (authError) {
                    authError.textContent = message;
                    authError.style.display = 'block';
                }
            }
            
            // If auto-auth fails, prompt user
            // (This block should be inside a method, not outside the class)
            // Remove this misplaced code or move it to the appropriate method if needed.

            updateAuthButtonState(authenticated) {
                const authBtn = document.querySelector('.auth-btn');
                if (authBtn) {
                    if (authenticated) {
                        authBtn.classList.add('authenticated');
                        authBtn.title = 'Enhanced Data Access: ACTIVE';
                        authBtn.innerHTML = 'ðŸ”“';
                    } else {
                        authBtn.classList.remove('authenticated');
                        authBtn.title = 'Enhanced Data Access';
                        authBtn.innerHTML = 'ðŸ”‘';
                    }
                }
            }
            
            promptForCredentials() {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.8); z-index: 9999; 
                    display: flex; align-items: center; justify-content: center;
                `;
                
                modal.innerHTML = `
                    <div style="background: #2c3e50; padding: 2rem; border-radius: 10px; max-width: 400px; width: 90%;">
                        <h3 style="color: #3498db; margin-bottom: 1rem;">Enhanced Data Access</h3>
                        <p style="margin-bottom: 1rem; color: #bdc3c7; font-size: 0.9rem;">
                            Enter your PRTG authentication credentials (username and passhash) to access real-time monitoring data and detailed analytics.
                        </p>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #95a5a6;">Username:</label>
                            <input type="text" id="auth-username" value="LoginApiUser" style="width: 100%; padding: 0.5rem; border: 1px solid #34495e; border-radius: 4px; background: #34495e; color: white;" placeholder="Enter username">
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #95a5a6;">Passhash:</label>
                            <input type="password" id="auth-password" value="730802978" style="width: 100%; padding: 0.5rem; border: 1px solid #34495e; border-radius: 4px; background: #34495e; color: white;" placeholder="Enter passhash">
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button onclick="dashboard.setAuthentication()" style="flex: 1; background: #3498db; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">Connect</button>
                            <button onclick="dashboard.closeAuthModal()" style="flex: 1; background: #95a5a6; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">Cancel</button>
                        </div>
                        <div id="auth-status" style="margin-top: 1rem; text-align: center; color: #e74c3c; font-size: 0.85rem;"></div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                this.authModal = modal;
                document.getElementById('auth-username').focus();
                
                // Allow Enter key to submit
                ['auth-username', 'auth-password'].forEach(id => {
                    document.getElementById(id).addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.setAuthentication();
                    });
                });
            }
            
            async setAuthentication() {
                const username = document.getElementById('auth-username').value;
                const password = document.getElementById('auth-password').value;
                const statusEl = document.getElementById('auth-status');
                
                if (!username || !password) {
                    statusEl.textContent = 'Please enter both username and password';
                    return;
                }
                
                statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating credentials...';
                
                try {
                    // Authenticate via the server's login endpoint
                    const loginResponse = await fetch('/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password }),
                        credentials: 'include' // Important for session cookies
                    });
                    
                    const loginResult = await loginResponse.json();
                    
                    if (loginResponse.ok && loginResult.success) {
                        // Set credentials in auth manager for any direct API calls
                        this.authManager.setCredentials(username, password);
                        statusEl.innerHTML = '<i class="fas fa-check"></i> Authentication successful!';
                        statusEl.style.color = '#27ae60';
                        
                        // Update auth button to show authenticated state
                        this.updateAuthButtonState(true);
                        
                        setTimeout(() => {
                            this.closeAuthModal();
                            this.showEnhancedDataNotification();
                            this.refreshData(); // Reload with authenticated access
                        }, 1000);
                    } else {
                        statusEl.textContent = loginResult.error || 'Authentication failed. Please check your credentials.';
                    }
                } catch (error) {
                    console.error('Authentication error:', error);
                    statusEl.textContent = 'Connection error. Please try again.';
                }
            }
            
            closeAuthModal() {
                if (this.authModal) {
                    document.body.removeChild(this.authModal);
                    this.authModal = null;
                }
            }
            
            showEnhancedDataNotification() {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed; top: 20px; right: 20px; 
                    background: linear-gradient(135deg, #27ae60, #2ecc71); 
                    color: white; padding: 1rem 1.5rem; border-radius: 8px; 
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1000;
                    animation: slideIn 0.3s ease-out;
                `;
                
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>Enhanced Data Access Enabled!</strong><br>
                            <small>Real-time monitoring and detailed analytics now available</small>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; margin-left: 1rem;">&times;</button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.parentElement.removeChild(notification);
                    }
                }, 5000);
            }

            filterByStatus(status) {
                // Update the status filter dropdown
                const statusFilter = document.getElementById('statusFilter');
                if (statusFilter) {
                    statusFilter.value = status;
                }
                
                // Apply the filter
                this.filters.status = status;
                this.applyFilters();
                
                // Scroll to the device list
                const companiesList = document.getElementById('companiesList');
                if (companiesList) {
                    companiesList.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            setupEventListeners() {
                document.getElementById('searchBox').addEventListener('input', (e) => {
                    this.filters.search = e.target.value.toLowerCase();
                    this.applyFilters();
                });

                document.getElementById('statusFilter').addEventListener('change', (e) => {
                    this.filters.status = e.target.value;
                    this.applyFilters();
                });

                document.getElementById('companyFilter').addEventListener('change', (e) => {
                    this.filters.company = e.target.value;
                    this.applyFilters();
                });
            }

            async loadData() {
                // Prevent concurrent data loads
                if (this.isLoading) {
                    console.log('âš ï¸ Data load already in progress, skipping duplicate request');
                    // Hide any stale progress indicators
                    this.hideLoadingProgress();
                    return;
                }
                
                console.log(`ðŸ”„ ==================== LOAD DATA START ====================`);
                console.log(`   Called at: ${new Date().toISOString()}`);
                console.log(`   Current devices: ${this.devices.length}`);
                console.log(`   Max ever seen: ${this.maxDeviceCountEverSeen}`);
                console.log(`   Initial complete: ${this.initialLoadComplete}`);
                console.log(`   Is loading: ${this.isLoading}`);
                console.trace('loadData call stack'); // Show where this was called from
                console.log(`ðŸ”„ ============================================================`);
                this.isLoading = true;
                let retryCount = 0;
                const maxRetries = 10; // Increased from 5 to 10 for better persistence
                
                try {
                    while (retryCount < maxRetries) {
                        try {
                            // Show loading progress
                            if (retryCount === 0) {
                                this.showLoadingProgress(0, 'Starting device data retrieval...');
                            } else {
                                this.showLoadingProgress(0, `Retry attempt ${retryCount}/${maxRetries}...`);
                            }
                            
                            // Load all devices with pagination - WAIT for completion
                            const loadedDevices = await this.loadAllDevices();
                            
                            // Ensure we have devices before proceeding
                            if (!loadedDevices || loadedDevices.length === 0) {
                                console.warn(`No devices loaded on attempt ${retryCount + 1}, retrying...`);
                                retryCount++;
                                
                                if (retryCount < maxRetries) {
                                    this.showLoadingProgress(10, `No devices loaded, retrying in 3 seconds... (${retryCount}/${maxRetries})`);
                                    await new Promise(resolve => setTimeout(resolve, 3000));
                                    continue;
                                } else {
                                    throw new Error('Failed to load devices after maximum retries');
                                }
                            }
                            
                            // Only update devices array after successful load
                            console.log(`ðŸŽ¯ ==================== GUARD CLAUSE CHECK ====================`);
                            console.log(`   Loaded from API: ${loadedDevices.length} devices`);
                            console.log(`   Current in memory: ${this.devices.length} devices`);
                            console.log(`   Historical max: ${this.maxDeviceCountEverSeen}`);
                            console.log(`   this.devices.length === 0? ${this.devices.length === 0}`);
                            console.log(`   loadedDevices.length > this.devices.length? ${loadedDevices.length} > ${this.devices.length} = ${loadedDevices.length > this.devices.length}`);
                            
                            // SIMPLE RULE: Only accept new data if it has MORE devices than current
                            // Exception: If current is empty (first load), accept anything
                            const shouldAccept = (this.devices.length === 0) || (loadedDevices.length > this.devices.length);
                            console.log(`   DECISION: shouldAccept = ${shouldAccept}`);
                            console.log(`ðŸŽ¯ ============================================================`);
                            
                            if (shouldAccept) {
                                this.devices = loadedDevices;
                                if (loadedDevices.length > this.maxDeviceCountEverSeen) {
                                    this.maxDeviceCountEverSeen = loadedDevices.length;
                                }
                                console.log(`âœ… ACCEPTED: Updated to ${this.devices.length} devices (max ever: ${this.maxDeviceCountEverSeen})`);
                            } else {
                                console.warn(`ðŸš« REJECTED: New data has ${loadedDevices.length} but current has ${this.devices.length}`);
                                console.warn(`   Keeping current ${this.devices.length} devices`);
                            }
                            
                            // Update connection status immediately after data decision
                            this.updateConnectionStatus('connected', 'Authenticated & Connected');
                            
                            // Process and render data only after devices are loaded
                            this.showLoadingProgress(85, 'Processing company data...');
                            this.processCompanyData();
                            
                            this.showLoadingProgress(90, 'Rendering dashboard...');
                            this.updateOverviewStats();
                            this.renderCompanies();
                            this.populateCompanyFilter();
                            
                            this.showLoadingProgress(100, 'Complete!');
                            
                            // Wait 500ms before hiding to show success
                            await new Promise(resolve => setTimeout(resolve, 500));
                            this.hideLoadingProgress();
                            
                            // Clear any retry messages and show normal connected status
                            this.updateConnectionStatus(true, 'Connected');
                            this.updateLastUpdateTime();
                            
                            // Mark initial load as complete
                            if (!this.initialLoadComplete) {
                                this.initialLoadComplete = true;
                                console.log('âœ… Initial load complete, auto-refresh and WebSocket updates now enabled');
                            }
                            
                            // Success - break out of retry loop
                            break;
                        
                        } catch (error) {
                            console.error(`Error loading data (attempt ${retryCount + 1}):`, error);
                            retryCount++;
                            
                            if (retryCount < maxRetries) {
                                // Exponential backoff with fun messages
                                const retryDelay = Math.min(3000 * Math.pow(1.5, retryCount - 1), 15000);
                                const funRetryMessages = [
                                    `ðŸ”„ Round ${retryCount}: The API needs a moment...`,
                                    `â³ Attempt ${retryCount}: Patience is a virtue...`,
                                    `ðŸŽ² Try ${retryCount}: Third time's the charm (or maybe ${retryCount}th)...`,
                                    `ðŸš€ Retry ${retryCount}: Houston, we have persistence...`,
                                    `ðŸŽ¯ Attempt ${retryCount}: Getting warmer...`,
                                    `ðŸ’ª Try ${retryCount}: Never give up, never surrender!`,
                                    `ðŸŒŸ Retry ${retryCount}: Good things come to those who wait...`,
                                    `ðŸ”® Attempt ${retryCount}: The data crystal ball is hazy...`,
                                    `âš¡ Try ${retryCount}: Charging connection capacitors...`,
                                    `ðŸŽª Retry ${retryCount}: The show must go on!`
                                ];
                                const retryMsg = funRetryMessages[Math.min(retryCount - 1, funRetryMessages.length - 1)];
                                this.showLoadingProgress(10, `${retryMsg} (${Math.round(retryDelay/1000)}s)`);
                                await new Promise(resolve => setTimeout(resolve, retryDelay));
                            } else {
                                // Final failure after all retries - only clear if we have no existing data
                                if (!this.devices || this.devices.length === 0) {
                                    this.showLoadingProgress(0, 'âŒ Failed to load devices after multiple attempts');
                                    await new Promise(resolve => setTimeout(resolve, 2000));
                                    this.hideLoadingProgress();
                                    this.updateConnectionStatus(false);
                                    this.showErrorMessage('Failed to load dashboard data after multiple attempts. Please refresh the page.');
                                } else {
                                    // Keep existing data visible if we already have devices loaded
                                    console.warn('âš ï¸ Refresh failed but keeping existing data visible');
                                    this.hideLoadingProgress();
                                    this.updateConnectionStatus(true);
                                }
                            }
                        }
                    }
                } finally {
                    // Always release the loading lock
                    this.isLoading = false;
                    console.log(`ðŸ”“ loadData() finished, isLoading set to false, final device count: ${this.devices.length}`);
                }
            }

            groupDevicesByCompany(devices) {
                const companies = {};
                devices.forEach(d => {
                    const code = d.companyCode || this.extractCompanyCode(d.name) || 'UNKNOWN';
                    companies[code] = (companies[code] || 0) + 1;
                });
                return companies;
            }

            async loadAllDevices() {
                // Use pagination as primary method for consistency (no more alternating 200/920)
                this.showLoadingProgress(10, 'Loading devices...');
                console.log(`ðŸš€ loadAllDevices() called at ${new Date().toISOString()}`);
                console.log('ðŸ“Š Using pagination for consistent device loading');
                const result = await this.loadDevicesWithPagination();
                console.log(`ðŸ loadAllDevices() returning ${result.length} devices at ${new Date().toISOString()}`);
                return result;
            }

            async loadDevicesWithPagination() {
                console.log(`ðŸ“¦ ==================== PAGINATION START ====================`);
                const allDevices = [];
                let offset = 0;
                const limit = 200; // Load in chunks of 200
                let hasMore = true;
                let totalExpected = null;
                let failureCount = 0;
                const maxFailures = 3;

                // Show loading indicator
                this.showLoadingProgress(20, 'Loading devices in batches...');

                while (hasMore && failureCount < maxFailures) {
                    console.log(`ðŸ“¥ Fetching page: offset=${offset}, limit=${limit}, total loaded so far: ${allDevices.length}`);
                    try {
                        // Add timeout per request (60 seconds for large queries with sensors/metadata)
                        const timeout = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Request timeout')), 60000)
                        );
                        
                        // Use authenticated fetch for consistent session
                        const fetchPromise = this.authManager.authenticatedFetch(`/api/devices/enhanced?limit=${limit}&offset=${offset}`);
                        const response = await Promise.race([fetchPromise, timeout]);
                        
                        if (!response.ok) {
                            // Fallback to regular devices API if enhanced fails
                            const fallbackPromise = this.authManager.authenticatedFetch(`/api/devices?limit=${limit}&offset=${offset}`);
                            const fallbackResponse = await Promise.race([fallbackPromise, timeout]);
                            
                            if (fallbackResponse.ok) {
                                const devices = await fallbackResponse.json();
                                allDevices.push(...devices);
                                hasMore = devices.length === limit;
                                failureCount = 0; // Reset on success
                            } else {
                                console.error('Both device APIs failed, attempt', failureCount + 1);
                                failureCount++;
                                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1s before retry
                                continue;
                            }
                        } else {
                            const responseData = await response.json();
                            console.log(`ðŸ“¡ Raw API response type:`, typeof responseData, Array.isArray(responseData) ? '(array)' : '(object)');
                            console.log(`ðŸ“¡ Response has 'devices' property?`, 'devices' in responseData);
                            console.log(`ðŸ“¡ Response has 'pagination' property?`, 'pagination' in responseData);
                            console.log(`ðŸ“¡ Full pagination object:`, JSON.stringify(responseData.pagination));
                            
                            const devices = responseData.devices || responseData;
                            
                            console.log(`âœ… Received ${devices.length} devices, adding to total: ${allDevices.length}`);
                            allDevices.push(...devices);
                            console.log(`ðŸ“Š Total devices now: ${allDevices.length}`);
                            failureCount = 0; // Reset on success
                            
                            // Check if we have pagination metadata
                            if (responseData.pagination) {
                                hasMore = responseData.pagination.hasMore;
                                totalExpected = responseData.pagination.total;
                                console.log(`ðŸ”„ hasMore from API: ${hasMore}, page ${responseData.pagination.page}/${responseData.pagination.totalPages}, total expected: ${totalExpected}`);
                                
                                // Update loading progress (20% to 80% during load)
                                const progressPercent = 20 + Math.min((allDevices.length / totalExpected) * 60, 60);
                                this.showLoadingProgress(
                                    progressPercent, 
                                    `Loading devices... ${allDevices.length}/${totalExpected} (${Math.round((allDevices.length / totalExpected) * 100)}%)`
                                );
                                
                                console.debug(`ðŸ“¦ Loaded batch ${responseData.pagination.page}/${responseData.pagination.totalPages} (${devices.length} devices)`);
                            } else {
                                // Legacy response without pagination metadata
                                console.log(`âš ï¸ No pagination metadata, using legacy logic: hasMore = ${devices.length} === ${limit}`);
                                hasMore = devices.length === limit;
                                console.log(`ðŸ”„ hasMore set to: ${hasMore}`);
                                const progressPercent = 20 + Math.min((allDevices.length / 1000) * 60, 60);
                                this.showLoadingProgress(progressPercent, `Loaded ${allDevices.length} devices...`);
                            }
                        }
                        
                        offset += limit;
                        console.log(`âž¡ï¸ Moving to next page: offset now ${offset}, hasMore=${hasMore}`);
                        
                        // Safety check to prevent infinite loops
                        if (offset > 10000) {
                            console.warn('âš ï¸ Reached safety limit of 10000 devices');
                            break;
                        }
                        
                        if (!hasMore) {
                            console.log(`ðŸ›‘ hasMore is false, stopping pagination. Final count: ${allDevices.length}`);
                        }
                        
                    } catch (error) {
                        console.error('Error loading devices chunk:', error.message);
                        failureCount++;
                        if (failureCount >= maxFailures) {
                            console.error('âŒ Maximum failures reached, stopping pagination');
                            this.showLoadingProgress(50, `âš ï¸ Connection issues - loaded ${allDevices.length} devices`);
                            break;
                        }
                        // Wait before retrying
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }

                // Ensure we show completion
                if (allDevices.length > 0) {
                    this.showLoadingProgress(80, `Pagination complete: ${allDevices.length} devices loaded`);
                    console.log(`âœ… Total devices loaded via pagination: ${allDevices.length}`);
                    console.log(`ðŸ“Š Device breakdown by company:`, this.groupDevicesByCompany(allDevices));
                } else {
                    this.showLoadingProgress(50, 'âš ï¸ No devices loaded - check connection');
                    console.error('âŒ No devices were loaded');
                }
                console.log(`ðŸ“¦ ==================== PAGINATION COMPLETE ====================`);
                console.log(`   Returning ${allDevices.length} devices to loadData()`);
                console.log(`ðŸ“¦ ============================================================`);
                return allDevices;
            }

            showLoadingProgress(percent, message) {
                let loadingEl = document.getElementById('loadingProgress');
                if (!loadingEl) {
                    loadingEl = document.createElement('div');
                    loadingEl.id = 'loadingProgress';
                    
                    // Fun loading messages rotation
                    const funMessages = [
                        'ðŸš€ Launching network analysis engines...',
                        'ðŸ” Scanning the digital horizon...',
                        'âš¡ Energizing monitoring systems...',
                        'ðŸŽ¯ Targeting device telemetry...',
                        'ðŸŒ Connecting to the matrix...',
                        'ðŸ”¬ Analyzing infrastructure DNA...',
                        'ðŸŽ¨ Painting your network topology...',
                        'ðŸ§  Teaching AI about your devices...',
                        'ðŸ“¡ Tuning satellite uplinks...',
                        'ðŸŽª Preparing the monitoring circus...'
                    ];
                    
                    // Select a random fun message if this is initial load
                    if (percent < 20 && !message.includes('Retry')) {
                        message = funMessages[Math.floor(Math.random() * funMessages.length)];
                    }
                    
                    loadingEl.style.cssText = `
                        position: fixed; top: 70px; right: 20px; 
                        background: rgba(52, 73, 94, 0.95); 
                        padding: 15px 20px; border-radius: 8px;
                        color: white; font-size: 14px; z-index: 1000;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        border-left: 4px solid #3498db;
                    `;
                    document.body.appendChild(loadingEl);
                }
                
                let progressBar = '';
                if (percent !== null) {
                    progressBar = `
                        <div style="width: 200px; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-top: 8px; overflow: hidden;">
                            <div style="width: ${percent}%; height: 100%; background: #3498db; border-radius: 3px; transition: width 0.3s ease;"></div>
                        </div>
                    `;
                }
                
                loadingEl.innerHTML = message + progressBar;
            }

            hideLoadingProgress() {
                const loadingEl = document.getElementById('loadingProgress');
                if (loadingEl) {
                    loadingEl.remove();
                }
            }

            processCompanyData() {
                console.log(`ðŸ”§ processCompanyData() called with ${this.devices.length} devices`);
                this.companies.clear();
                
                // Debug: Log first few devices to see their structure
                if (this.devices.length > 0) {
                    console.log('ðŸ“Š Sample device data:', this.devices.slice(0, 2));
                }
                
                // Group devices by company
                let processedCount = 0;
                this.devices.forEach(device => {
                    processedCount++;
                    // Use enhanced company data if available, otherwise extract from name
                    const companyCode = device.companyCode || this.extractCompanyCode(device.name);
                    const companyName = device.companyName || this.getCompanyName(companyCode);
                    
                    if (!this.companies.has(companyCode)) {
                        this.companies.set(companyCode, {
                            code: companyCode,
                            name: companyName,
                            devices: [],
                            stats: {
                                total: 0,
                                up: 0,
                                down: 0,
                                warning: 0,
                                paused: 0,
                                unusual: 0
                            },
                            sensorStats: {
                                total: 0,
                                up: 0,
                                down: 0,
                                warning: 0,
                                paused: 0,
                                unusual: 0
                            },
                            totalAlerts: 0,
                            avgHealthScore: 0
                        });
                    }
                    
                    const company = this.companies.get(companyCode);
                    const enhancedDevice = this.enhanceDeviceData(device);
                    company.devices.push(enhancedDevice);
                    company.stats.total++;
                    
                    // Update device status counts - use effectiveStatus if available
                    const effectiveStatus = device.effectiveStatus || device.status;
                    const statusKey = this.getStatusKey(effectiveStatus);
                    if (company.stats.hasOwnProperty(statusKey)) {
                        company.stats[statusKey]++;
                    }
                    
                    // Aggregate sensor statistics if available
                    if (device.sensorStats) {
                        company.sensorStats.total += device.sensorStats.total;
                        company.sensorStats.up += device.sensorStats.up;
                        company.sensorStats.down += device.sensorStats.down;
                        company.sensorStats.warning += device.sensorStats.warning;
                        company.sensorStats.paused += device.sensorStats.paused;
                        company.sensorStats.unusual += device.sensorStats.unusual;
                        
                        company.totalAlerts += (device.alertCount || 0);
                    }
                });
                
                // Debug: Log company stats summary
                console.log(`ðŸ“ˆ Company stats processed: ${processedCount} devices processed into ${this.companies.size} companies`);
                this.companies.forEach((company, code) => {
                    console.log(`  ${code}: ${company.devices.length} devices, ${company.stats.down} down, ${company.stats.warning} warning, ${company.stats.up} up (${company.sensorStats.down} sensors down, ${company.sensorStats.warning} sensors warning)`);
                });
                
                // Calculate average health scores for companies
                this.companies.forEach(company => {
                    if (company.devices.length > 0) {
                        const totalHealthScore = company.devices.reduce((sum, device) => {
                            return sum + (device.healthScore || 75); // Default health score
                        }, 0);
                        company.avgHealthScore = Math.round(totalHealthScore / company.devices.length);
                    }
                });
            }

            extractCompanyCode(deviceName) {
                // Extract company codes from device names
                const patterns = [
                    /^([A-Z]{2,4})-/,  // VEC-, DEC-, etc.
                    /^([A-Za-z]+)-/,   // CalTel-, etc.
                ];
                
                for (const pattern of patterns) {
                    const match = deviceName.match(pattern);
                    if (match) {
                        return match[1].toUpperCase();
                    }
                }
                
                return 'OTHER'; // Default for unmatched devices
            }

            getCompanyName(companyCode) {
                const companyNames = {
                    'AJ': 'AJ Network Solutions',
                    'ANA': 'Anaheim Communications',
                    'CALTEL': 'California Telecom',
                    'COMUNIDAD': 'Comunidad Network',
                    'CPM': 'Control Point Monitor',
                    'DEC': 'Digital Edge Communications',
                    'E': 'E-Networks',
                    'EBA': 'Enterprise Business Associates',
                    'GPS': 'GPS Network Systems',
                    'GRACE': 'Grace Communications',
                    'MARICOPA': 'Maricopa County Network',
                    'MBS': 'MBS Communications',
                    'MBSE': 'MBSE Network Services',
                    'MUN': 'Municipal Networks',
                    'PHLABS': 'Phoenix Labs',
                    'PRESSACAD': 'Press Academy Network',
                    'PRTG': 'PRTG Core Services',
                    'SAC': 'Sacramento Communications',
                    'SANTAN': 'Santan Network Services',
                    'SEY': 'Seymour Networks',
                    'SFS': 'SFS Communications',
                    'SRCO': 'SRCO Network Solutions',
                    'TBA': 'TBA Communications',
                    'TCC': 'TCC Network Services',
                    'TOW': 'Tower Communications',
                    'VEC': 'Vector Communications',
                    'VN': 'VN Networks',
                    'OTHER': 'Unclassified Devices'
                };
                
                return companyNames[companyCode] || `${companyCode} Network`;
            }

            enhanceDeviceData(device) {
                return {
                    ...device,
                    deviceType: device.deviceType || device.device_type || this.getDeviceType(device.name),
                    criticality: this.getCriticality(device.name),
                    sensorCount: device.sensors?.length || 0,
                    alertCount: device.sensors?.filter(s => s.status === 5 || s.status === 4).length || 0
                };
            }

            getDeviceType(deviceName) {
                const types = {
                    'ESX': 'VMware Server',
                    'ESXI': 'VMware Server',
                    'PDU': 'Power Distribution',
                    'APC': 'UPS/Power',
                    'CORE': 'Core Switch',
                    'SW': 'Network Switch',
                    'FW': 'Firewall',
                    'AP': 'Access Point',
                    'WLC': 'Wireless Controller',
                    'MPLS': 'MPLS Router'
                };
                
                const upperName = deviceName.toUpperCase();
                for (const [key, value] of Object.entries(types)) {
                    if (upperName.includes(key)) {
                        return value;
                    }
                }
                return 'Network Device';
            }

            getCriticality(deviceName) {
                const upperName = deviceName.toUpperCase();
                if (upperName.includes('CORE') || upperName.includes('FW') || upperName.includes('ESXI')) {
                    return 'high';
                } else if (upperName.includes('SW') || upperName.includes('PDU') || upperName.includes('APC')) {
                    return 'medium';
                } else {
                    return 'low';
                }
            }

            getStatusKey(statusCode) {
                const statusMap = {
                    3: 'up',
                    4: 'warning',
                    5: 'down',
                    7: 'paused',
                    10: 'unusual',
                    1: 'unusual'
                };
                return statusMap[statusCode] || 'unusual';
            }

            updateOverviewStats() {
                const stats = {
                    total: this.devices.length,
                    companies: this.companies.size,
                    up: 0,
                    down: 0,
                    warning: 0
                };

                this.devices.forEach(device => {
                    // Use effectiveStatus if available (reflects sensor states)
                    const effectiveStatus = device.effectiveStatus || device.status;
                    const statusKey = this.getStatusKey(effectiveStatus);
                    if (stats.hasOwnProperty(statusKey)) {
                        stats[statusKey]++;
                    }
                });
                
                console.log('ðŸ“Š Overview stats:', stats);

                const overviewHtml = `
                    <div class="stat-card total clickable" onclick="dashboard.filterByStatus('all')" title="Click to show all devices">
                        <div class="stat-number">${stats.total}</div>
                        <div class="stat-label">Total Devices</div>
                    </div>
                    <div class="stat-card companies">
                        <div class="stat-number">${stats.companies}</div>
                        <div class="stat-label">Companies</div>
                    </div>
                    <div class="stat-card up clickable" onclick="dashboard.filterByStatus('up')" title="Click to show online devices">
                        <div class="stat-number">${stats.up}</div>
                        <div class="stat-label">Online</div>
                    </div>
                    <div class="stat-card warning clickable" onclick="dashboard.filterByStatus('warning')" title="Click to show warning devices">
                        <div class="stat-number">${stats.warning}</div>
                        <div class="stat-label">Warning</div>
                    </div>
                    <div class="stat-card down clickable" onclick="dashboard.filterByStatus('down')" title="Click to show offline devices">
                        <div class="stat-number">${stats.down}</div>
                        <div class="stat-label">Offline</div>
                    </div>
                `;

                document.getElementById('overviewStats').innerHTML = overviewHtml;

                // Update header status indicators
                this.updateHeaderStats(stats);
            }

            updateHeaderStats(stats) {
                const totalDevicesHeader = document.getElementById('totalDevicesHeader');
                const criticalAlertsHeader = document.getElementById('criticalAlertsHeader');
                const warningAlertsHeader = document.getElementById('warningAlertsHeader');
                const healthyDevicesHeader = document.getElementById('healthyDevicesHeader');
                const healthBar = document.getElementById('healthBar');

                if (totalDevicesHeader) totalDevicesHeader.textContent = stats.total.toLocaleString();
                if (criticalAlertsHeader) criticalAlertsHeader.textContent = stats.down;
                if (warningAlertsHeader) warningAlertsHeader.textContent = stats.warning;
                if (healthyDevicesHeader) healthyDevicesHeader.textContent = stats.up;
                
                // Update health bar percentage
                if (healthBar && stats.total > 0) {
                    const healthPercent = (stats.up / stats.total) * 100;
                    healthBar.style.width = healthPercent + '%';
                    
                    // Change color based on health level
                    if (healthPercent >= 90) {
                        healthBar.style.background = 'linear-gradient(90deg, #27ae60, #2ecc71)';
                    } else if (healthPercent >= 70) {
                        healthBar.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
                    } else {
                        healthBar.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
                    }
                }
                
                // Update telemetry indicators visibility
                this.updateTelemetryIndicators(stats);
            }

            updateTelemetryIndicators(stats) {
                // Show/hide critical alerts
                const criticalItem = document.querySelector('.telemetry-item.critical');
                if (criticalItem) {
                    criticalItem.style.opacity = stats.down > 0 ? '1' : '0.3';
                }
                
                // Show/hide warnings
                const warningItem = document.querySelector('.telemetry-item.warning');
                if (warningItem) {
                    warningItem.style.opacity = stats.warning > 0 ? '1' : '0.3';
                }
            }

            renderCompanies() {
                const container = document.getElementById('companiesGrid');
                if (this.companies.size === 0) {
                    container.innerHTML = '<div class="no-data">No company data available</div>';
                    return;
                }

                const companiesArray = Array.from(this.companies.values())
                    .sort((a, b) => a.name.localeCompare(b.name));

                const html = companiesArray.map(company => this.renderCompanySection(company)).join('');
                container.innerHTML = html;

                // Add click listeners for expand/collapse
                document.querySelectorAll('.company-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const section = header.closest('.company-section');
                        section.classList.toggle('expanded');
                    });
                });
            }

            renderCompanySection(company) {
                const primaryStatus = company.stats.down > 0 ? 'down' : 
                                   company.stats.warning > 0 ? 'warning' : 'up';
                
                const alertCount = company.stats.down + company.stats.warning;

                return `
                    <div class="company-section" data-company="${company.code}">
                        <div class="company-header">
                            <div class="company-name-container">
                                <div class="company-name">${company.name}</div>
                                <div class="company-code">(${company.code})</div>
                            </div>
                            <div class="company-stats">
                                <div class="stat-item">
                                    <span class="stat-value">${company.stats.total}</span>
                                    <span class="stat-label">Devices</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value">${company.devices.reduce((sum, d) => sum + d.sensorCount, 0)}</span>
                                    <span class="stat-label">Sensors</span>
                                </div>
                                <div class="stat-item ${primaryStatus}">
                                    <span class="stat-value">${company.stats.up}/${company.stats.down}</span>
                                    <span class="stat-label">UP/DOWN</span>
                                </div>
                                <div class="expand-toggle">
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                            </div>
                        </div>
                        <div class="company-content">
                            <div class="devices-grid">
                                ${company.devices.map(device => this.renderDeviceCard(device)).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderDeviceCard(device) {
                const statusClass = `status-${this.getStatusKey(device.status)}`;
                const statusText = this.getStatusText(device.status);
                const statusColor = this.getStatusColor(device.status);

                return `
                    <div class="device-card ${statusClass}" onclick="showDeviceDetail(${device.id}, '${device.name.replace(/'/g, '\\\'')}')" data-device-id="${device.id}">
                        <div class="device-header">
                            <div>
                                <div class="device-name">${device.name}</div>
                                <div class="device-type">${device.deviceType}</div>
                            </div>
                            <div class="device-status" style="background: ${statusColor}; color: white;">
                                ${statusText}
                            </div>
                        </div>
                        <div class="device-details">
                            <div class="device-detail">
                                <span>Host:</span>
                                <span>${device.host || 'N/A'}</span>
                            </div>
                            <div class="device-detail">
                                <span>Group:</span>
                                <span>${device.group || 'Default'}</span>
                            </div>
                            <div class="device-detail">
                                <span>Priority:</span>
                                <span>${device.priority || 'Normal'}</span>
                            </div>
                            <div class="device-detail">
                                <span>Criticality:</span>
                                <span class="criticality-badge criticality-${device.criticality}">${device.criticality.toUpperCase()}</span>
                            </div>
                        </div>
                        <div class="sensors-summary">
                            <span class="sensor-count">${device.sensorCount} Sensors</span>
                            ${device.alertCount > 0 ? 
                                `<span class="criticality-badge criticality-high">${device.alertCount} Alerts</span>` : 
                                `<span class="criticality-badge criticality-low">Healthy</span>`
                            }
                        </div>
                    </div>
                `;
            }

            getStatusText(status) {
                const statusMap = {
                    3: 'Up',
                    4: 'Warning',
                    5: 'Down',
                    7: 'Paused',
                    10: 'Unusual',
                    1: 'Unknown'
                };
                return statusMap[status] || 'Unknown';
            }

            getStatusColor(status) {
                const colorMap = {
                    3: '#27ae60',
                    4: '#f39c12',
                    5: '#e74c3c',
                    7: '#95a5a6',
                    10: '#9b59b6',
                    1: '#7f8c8d'
                };
                return colorMap[status] || '#7f8c8d';
            }

            populateCompanyFilter() {
                const select = document.getElementById('companyFilter');
                select.innerHTML = '<option value="all">All Companies</option>';
                
                Array.from(this.companies.values()).sort((a, b) => a.name.localeCompare(b.name)).forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.code;
                    option.textContent = `${company.code} - ${company.name}`;
                    select.appendChild(option);
                });
            }

            applyFilters() {
                const companies = document.querySelectorAll('.company-section');
                
                companies.forEach(section => {
                    const companyCode = section.dataset.company;
                    const company = this.companies.get(companyCode);
                    
                    let shouldShow = true;
                    
                    // Company filter
                    if (this.filters.company !== 'all' && companyCode !== this.filters.company) {
                        shouldShow = false;
                    }
                    
                    // Search filter
                    if (this.filters.search && shouldShow) {
                        const searchMatch = company.name.toLowerCase().includes(this.filters.search) ||
                                          company.devices.some(d => d.name.toLowerCase().includes(this.filters.search));
                        if (!searchMatch) shouldShow = false;
                    }
                    
                    // Status filter
                    if (this.filters.status !== 'all' && shouldShow) {
                        const hasMatchingDevices = company.devices.some(d => 
                            this.getStatusKey(d.status) === this.filters.status
                        );
                        if (!hasMatchingDevices) shouldShow = false;
                    }
                    
                    section.style.display = shouldShow ? 'block' : 'none';
                });
            }

            connectWebSocket() {
                // Skip if WebSocket has been disabled due to repeated failures
                if (this.webSocketDisabled) {
                    return;
                }
                
                // Close existing WebSocket connection if any
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
                
                // Determine correct WebSocket URL - use same host/port as current page
                // This assumes WebSocket is proxied through the same server (Apache/nginx)
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.host; // includes port if non-standard
                
                // For HTTPS sites, use the same host/port (WebSocket should be proxied)
                // For direct HTTP access to port 3010, connect directly
                let wsUrl;
                if (window.location.protocol === 'https:') {
                    // HTTPS: Use same host, WebSocket will be proxied at /ws or similar
                    wsUrl = `${protocol}//${host}`;
                } else if (window.location.port === '3010') {
                    // Direct HTTP to port 3010
                    wsUrl = `${protocol}//${host}`;
                } else {
                    // Other HTTP scenarios - try port 3010
                    wsUrl = `${protocol}//${window.location.hostname}:3010`;
                }
                
                // Debug: Log the actual WebSocket URL being used (only on first attempt)
                if (this.reconnectAttempts === 0) {
                    console.log('WebSocket connecting to:', wsUrl, '(protocol:', protocol, 'host:', window.location.host, ')');
                }
                
                try {
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        // Only log successful connections
                        if (this.reconnectAttempts > 0) {
                            console.log('WebSocket reconnected successfully');
                        }
                        this.updateConnectionStatus(true);
                        this.reconnectAttempts = 0;
                        this.setupHeartbeat();
                    };
                    
                    this.ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleWebSocketMessage(data);
                        } catch (error) {
                            // Only log parse errors if they're not just heartbeat failures
                            console.warn('WebSocket message parsing failed');
                        }
                    };
                    
                    this.ws.onclose = () => {
                        this.updateConnectionStatus(false);
                        this.attemptReconnect();
                    };
                    
                    this.ws.onerror = (error) => {
                        // Reduce error logging - only log if not in retry loop
                        if (this.reconnectAttempts === 0) {
                            console.warn('WebSocket connection failed - attempting to reconnect');
                        }
                        this.updateConnectionStatus(false);
                    };
                } catch (error) {
                    if (this.reconnectAttempts === 0) {
                        console.warn('WebSocket connection failed - will retry');
                    }
                    this.updateConnectionStatus(false);
                }
            }

            handleWebSocketMessage(data) {
                if (data.type === 'dashboard_update') {
                    // Only trigger load if not already loading AND initial load is complete
                    if (!this.isLoading && this.initialLoadComplete) {
                        console.log(`ðŸ”Œ WebSocket triggered data refresh (current devices: ${this.devices.length})`);
                        this.loadData();
                    } else {
                        console.log('ðŸ”Œ WebSocket message received but load skipped (isLoading:', this.isLoading, 'initialLoadComplete:', this.initialLoadComplete, ')');
                    }
                } else if (data.type === 'device_update') {
                    this.updateDeviceData(data.device);
                }
            }

            updateDeviceData(updatedDevice) {
                const index = this.devices.findIndex(d => d.id === updatedDevice.id);
                if (index !== -1) {
                    this.devices[index] = updatedDevice;
                    this.processCompanyData();
                    this.updateOverviewStats();
                    this.renderCompanies();
                }
            }

            updateConnectionStatus(connected, customMessage = null) {
                const indicator = document.getElementById('connectionIndicator');
                const text = document.getElementById('connectionText');
                
                if (connected === true || connected === 'connected') {
                    indicator.classList.add('connected');
                    text.textContent = customMessage || 'Connected';
                } else {
                    indicator.classList.remove('connected');
                    text.textContent = customMessage || 'Disconnected';
                }
            }

            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    
                    // Exponential backoff: increase delay with each attempt
                    const delay = this.reconnectInterval * Math.pow(2, this.reconnectAttempts - 1);
                    
                    // Only log every 3rd attempt to reduce console spam
                    if (this.reconnectAttempts % 3 === 0) {
                        console.log(`WebSocket reconnection attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts}`);
                    }
                    
                    setTimeout(() => {
                        this.connectWebSocket();
                    }, Math.min(delay, 30000)); // Cap at 30 seconds max
                } else {
                    console.log('WebSocket disabled - dashboard operating in polling mode');
                    document.getElementById('connectionText').textContent = 'Polling Mode';
                    this.webSocketDisabled = true;
                }
            }

            setupHeartbeat() {
                setInterval(() => {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 30000);
            }

            startAutoRefresh() {
                setInterval(() => {
                    // Only auto-refresh if not already loading AND initial load is complete
                    if (!this.isLoading && this.initialLoadComplete) {
                        console.log(`â° Auto-refresh triggered (current devices: ${this.devices.length})`);
                        this.loadData();
                    }
                }, 60000); // Refresh every minute
            }

            async refreshData() {
                // Prevent refresh if already loading
                if (this.isLoading) {
                    console.log('âš ï¸ Data load already in progress, skipping refresh');
                    return;
                }
                
                const btn = document.querySelector('.refresh-btn');
                btn.textContent = 'Refreshing...';
                btn.disabled = true;
                
                // Store current devices as backup (but DON'T clear until new data loads)
                const backupDevices = [...this.devices];
                
                // DON'T clear this.devices here - keep existing data visible until refresh completes
                // This prevents the 920â†’200 flipping issue during pagination
                console.log(`ðŸ”„ Starting refresh with ${this.devices.length} devices currently loaded`);
                
                // Show refreshing message but keep current data displayed
                const grid = document.getElementById('companiesGrid');
                if (grid) {
                    // Don't clear the grid - just add a subtle indicator
                    const existingContent = grid.innerHTML;
                    grid.setAttribute('data-refreshing', 'true');
                }
                
                try {
                    // Force fresh load
                    await this.loadData();
                } catch (error) {
                    console.error('Refresh failed, restoring previous data:', error);
                    // Restore backup if refresh fails
                    this.devices = backupDevices;
                    if (this.devices.length > 0) {
                        this.processCompanyData();
                        this.renderCompanies();
                    }
                } finally {
                    btn.textContent = 'Refresh';
                    btn.disabled = false;
                }
            }

            updateLastUpdateTime() {
                document.getElementById('updateTime').textContent = new Date().toLocaleTimeString();
            }

            showErrorMessage(message) {
                const container = document.getElementById('companiesGrid');
                container.innerHTML = `<div class="no-data">âŒ ${message}</div>`;
            }
        }

        // Device Detail Functions
        async function showDeviceDetail(deviceId, deviceName) {
            const modal = document.getElementById('deviceDetailModal');
            const backdrop = document.getElementById('modalBackdrop');
            const title = document.getElementById('deviceDetailTitle');
            const content = document.getElementById('deviceDetailContent');
            
            // Show modal
            modal.classList.add('open');
            backdrop.classList.add('open');
            title.textContent = deviceName;
            
            // Show loading state
            content.innerHTML = `
                <div class="loading-detail">
                    <i class="fas fa-spinner fa-spin"></i> Loading detailed information...
                </div>
            `;
            
            try {
                // Fetch device details with authentication for enhanced data
                const authManager = window.dashboard.authManager;
                const [deviceResponse, sensorResponse, alertResponse, metadataResponse] = await Promise.allSettled([
                    authManager.authenticatedFetch(`/api/devices/${deviceId}`),
                    authManager.authenticatedFetch(`/api/sensors?deviceId=${deviceId}&limit=50`),
                    authManager.authenticatedFetch(`/api/alerts?hours=24&limit=10`),
                    fetch(`/api/devices/${deviceId}/metadata`)
                ]);
                
                let deviceData = null;
                let sensorsData = { sensors: [] };
                let alertsData = { alerts: [] };
                let metadataData = null;
                
                if (deviceResponse.status === 'fulfilled' && deviceResponse.value.ok) {
                    deviceData = await deviceResponse.value.json();
                }
                
                if (sensorResponse.status === 'fulfilled' && sensorResponse.value.ok) {
                    sensorsData = await sensorResponse.value.json();
                }
                
                if (alertResponse.status === 'fulfilled' && alertResponse.value.ok) {
                    alertsData = await alertResponse.value.json();
                }
                
                if (metadataResponse.status === 'fulfilled' && metadataResponse.value.ok) {
                    metadataData = await metadataResponse.value.json();
                }
                
                // Render detailed content
                renderDeviceDetailContent(deviceData, sensorsData, alertsData, metadataData, deviceId, deviceName);
                
            } catch (error) {
                console.error('Error loading device details:', error);
                content.innerHTML = `
                    <div class="detail-section">
                        <div class="detail-section-title">Error</div>
                        <p>Failed to load device details. Please try again.</p>
                    </div>
                `;
            }
        }
        
        function renderDeviceDetailContent(deviceData, sensorsData, alertsData, metadataData, deviceId, deviceName) {
            const content = document.getElementById('deviceDetailContent');
            
            const device = deviceData || { id: deviceId, name: deviceName };
            const sensors = sensorsData?.sensors || [];
            const alerts = alertsData?.alerts || [];
            const metadata = metadataData?.expandable_sections || {};
            
            const sensorStats = {
                total: sensors.length,
                up: sensors.filter(s => s.status === 3).length,
                down: sensors.filter(s => s.status === 5).length,
                warning: sensors.filter(s => s.status === 4).length,
                paused: sensors.filter(s => s.status === 7).length,
                unusual: sensors.filter(s => s.status === 10).length
            };
            
            content.innerHTML = `
                <!-- Device Overview -->
                <div class="detail-section">
                    <div class="detail-section-title">Device Overview</div>
                    <div class="detail-grid">
                        <div class="detail-label">Device ID</div>
                        <div class="detail-value">${device.id}</div>
                        <div class="detail-label">Host Address</div>
                        <div class="detail-value">${device.host || 'N/A'}</div>
                        <div class="detail-label">Device Type</div>
                        <div class="detail-value">${device.deviceType || 'Unknown'}</div>
                        <div class="detail-label">Status</div>
                        <div class="detail-value">${getStatusText(device.status) || 'Unknown'}</div>
                        <div class="detail-label">Priority</div>
                        <div class="detail-value">${device.priority || 'Normal'}</div>
                        <div class="detail-label">Last Seen</div>
                        <div class="detail-value">${device.lastSeen ? new Date(device.lastSeen).toLocaleString() : 'N/A'}</div>
                    </div>
                </div>
                
                <!-- Sensor Statistics -->
                <div class="detail-section">
                    <div class="detail-section-title">Sensor Statistics (${sensorStats.total} Total) - Click to filter</div>
                    <div class="detail-grid" style="gap: 0.5rem;">
                        <div class="detail-label" style="cursor: pointer; padding: 0.5rem; border-radius: 4px; background: rgba(46, 204, 113, 0.1);" onclick="filterSensorsByStatus(${device.id}, 'all')" title="Click to show all sensors">ðŸ”µ All Sensors</div>
                        <div class="detail-value" style="color: #2ecc71; cursor: pointer;" onclick="filterSensorsByStatus(${device.id}, 'all')">${sensorStats.total}</div>
                        <div class="detail-label" style="cursor: pointer; padding: 0.5rem; border-radius: 4px; background: rgba(39, 174, 96, 0.1);" onclick="filterSensorsByStatus(${device.id}, 3)" title="Click to show only UP sensors">ðŸŸ¢ Up/OK</div>
                        <div class="detail-value" style="color: #27ae60; cursor: pointer;" onclick="filterSensorsByStatus(${device.id}, 3)">${sensorStats.up}</div>
                        <div class="detail-label" style="cursor: pointer; padding: 0.5rem; border-radius: 4px; background: rgba(231, 76, 60, 0.1);" onclick="filterSensorsByStatus(${device.id}, 5)" title="Click to show only DOWN/ERROR sensors">ðŸ”´ Down/Error</div>
                        <div class="detail-value" style="color: #e74c3c; cursor: pointer; font-weight: bold;" onclick="filterSensorsByStatus(${device.id}, 5)">${sensorStats.down}</div>
                        <div class="detail-label" style="cursor: pointer; padding: 0.5rem; border-radius: 4px; background: rgba(243, 156, 18, 0.1);" onclick="filterSensorsByStatus(${device.id}, 4)" title="Click to show only WARNING sensors">ðŸŸ¡ Warning</div>
                        <div class="detail-value" style="color: #f39c12; cursor: pointer; font-weight: bold;" onclick="filterSensorsByStatus(${device.id}, 4)">${sensorStats.warning}</div>
                        <div class="detail-label" style="cursor: pointer; padding: 0.5rem; border-radius: 4px; background: rgba(149, 165, 166, 0.1);" onclick="filterSensorsByStatus(${device.id}, 7)" title="Click to show only PAUSED sensors">â¸ï¸ Paused</div>
                        <div class="detail-value" style="color: #95a5a6; cursor: pointer;" onclick="filterSensorsByStatus(${device.id}, 7)">${sensorStats.paused}</div>
                        <div class="detail-label" style="cursor: pointer; padding: 0.5rem; border-radius: 4px; background: rgba(155, 89, 182, 0.1);" onclick="filterSensorsByStatus(${device.id}, 10)" title="Click to show only UNUSUAL sensors">ðŸŸ£ Unusual</div>
                        <div class="detail-value" style="color: #9b59b6; cursor: pointer;" onclick="filterSensorsByStatus(${device.id}, 10)">${sensorStats.unusual}</div>
                    </div>
                </div>
                
                <!-- Sensors List -->
                <div class="detail-section">
                    <div class="detail-section-title" id="sensorListTitle">All Sensors (Showing ${Math.min(20, sensors.length)} of ${sensors.length})</div>
                    <div class="sensor-list" id="sensorList">
                        ${sensors.slice(0, 20).map(sensor => `
                            <div class="sensor-item ${getStatusKey(sensor.status)}" onclick="showSensorDetail(${sensor.id}, '${sensor.name.replace(/'/g, '\\\'')}')">
                                <div class="sensor-name">${sensor.name}</div>
                                <div class="sensor-details">
                                    <span class="sensor-type">${sensor.sensorType || sensor.sensor_type || 'Unknown'}</span>
                                    <span class="sensor-value">${sensor.lastValue || sensor.last_value || 'N/A'}</span>
                                </div>
                            </div>
                        `).join('')}
                        ${sensors.length > 20 ? `<div style="text-align: center; color: #95a5a6; padding: 1rem;">... and ${sensors.length - 20} more sensors</div>` : ''}
                        ${sensors.length === 0 ? '<div style="text-align: center; color: #95a5a6; padding: 1rem;">No sensors available</div>' : ''}
                    </div>
                </div>
                
                <!-- Recent Alerts -->
                ${alerts.length > 0 ? `
                <div class="detail-section">
                    <div class="detail-section-title">Recent Alerts (24h)</div>
                    <div class="alert-list">
                        ${alerts.slice(0, 10).map(alert => `
                            <div class="alert-item">
                                <div class="alert-time">${new Date(alert.timestamp).toLocaleString()}</div>
                                <div class="alert-message">${alert.message}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <!-- Extended Metadata -->
                ${Object.keys(metadata).length > 0 ? `
                <div class="detail-section">
                    <div class="detail-section-title">Extended Metadata</div>
                    ${Object.entries(metadata).map(([key, section]) => `
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #3498db; margin-bottom: 0.5rem;">${section.icon || 'ðŸ“Š'} ${section.label || key}</h4>
                            ${renderMetadataSection(section.data)}
                        </div>
                    `).join('')}
                </div>
                ` : ''}
                
                <!-- Future Integrations Placeholder -->
                <div class="detail-section">
                    <div class="detail-section-title">ðŸ”— External Integrations</div>
                    <div id="external-integrations-${deviceId}" style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 1rem;">
                        <div style="text-align: center; color: #95a5a6; padding: 1rem;">
                            <i class="fas fa-plug"></i><br>
                            External data sources (ConnectWise, ServiceNow, etc.) will appear here<br>
                            <small>Ready for integration expansion</small>
                        </div>
                    </div>
                </div>
                
                <!-- PRTG Raw Data -->
                <div class="detail-section">
                    <div class="detail-section-title">ðŸ”§ Technical Details</div>
                    <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 1rem;">
                        <details>
                            <summary style="cursor: pointer; color: #3498db; margin-bottom: 0.5rem;">Show Raw PRTG Data</summary>
                            <pre style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 4px; font-size: 0.75rem; overflow-x: auto; color: #95a5a6;">${JSON.stringify(device, null, 2)}</pre>
                        </details>
                    </div>
                </div>
            `;
        }
        
        function renderMetadataSection(data) {
            if (!data || typeof data !== 'object') return '<p>No data available</p>';
            
            let html = '<div class="detail-grid">';
            for (const [key, value] of Object.entries(data)) {
                if (key === 'sensors') continue; // Skip sensors as they're shown separately
                
                html += `
                    <div class="detail-label">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                    <div class="detail-value">${Array.isArray(value) ? value.join(', ') : value}</div>
                `;
            }
            html += '</div>';
            return html;
        }
        
        // Filter sensors by status within device detail view
        async function filterSensorsByStatus(deviceId, statusFilter) {
            const authManager = window.dashboard.authManager;
            
            try {
                // Fetch full device with all sensors
                const response = await authManager.authenticatedFetch(`/api/devices/${deviceId}`);
                if (!response.ok) {
                    console.error('Failed to fetch device sensors');
                    return;
                }
                
                const device = await response.json();
                const allSensors = device.sensors || [];
                
                // Filter sensors based on status
                let filteredSensors = allSensors;
                let filterLabel = 'All Sensors';
                
                if (statusFilter !== 'all') {
                    filteredSensors = allSensors.filter(s => s.status === parseInt(statusFilter));
                    const statusMap = {
                        3: 'ðŸŸ¢ UP/OK',
                        4: 'ðŸŸ¡ WARNING',
                        5: 'ðŸ”´ DOWN/ERROR',
                        7: 'â¸ï¸ PAUSED',
                        10: 'ðŸŸ£ UNUSUAL'
                    };
                    filterLabel = statusMap[statusFilter] || 'Filtered';
                }
                
                // Update sensor list title
                const titleEl = document.getElementById('sensorListTitle');
                if (titleEl) {
                    titleEl.textContent = `${filterLabel} Sensors (Showing ${Math.min(100, filteredSensors.length)} of ${filteredSensors.length})`;
                    titleEl.style.color = statusFilter === 5 ? '#e74c3c' : statusFilter === 4 ? '#f39c12' : '';
                }
                
                // Update sensor list content
                const listEl = document.getElementById('sensorList');
                if (listEl) {
                    if (filteredSensors.length === 0) {
                        listEl.innerHTML = '<div style="text-align: center; color: #95a5a6; padding: 2rem;">No sensors found with this status</div>';
                    } else {
                        listEl.innerHTML = filteredSensors.slice(0, 100).map(sensor => `
                            <div class="sensor-item ${getStatusKey(sensor.status)}" onclick="showSensorDetail(${sensor.id}, '${sensor.name.replace(/'/g, '\\\'')}')">
                                <div class="sensor-name">${sensor.name}</div>
                                <div class="sensor-details">
                                    <span class="sensor-type">${sensor.sensorType || sensor.sensor_type || 'Unknown'}</span>
                                    <span class="sensor-value">${sensor.lastValue || sensor.last_value || 'N/A'}</span>
                                    <span class="sensor-status" style="color: ${getStatusColor(sensor.status)}">${getStatusText(sensor.status)}</span>
                                </div>
                            </div>
                        `).join('') + (filteredSensors.length > 100 ? 
                            `<div style="text-align: center; color: #95a5a6; padding: 1rem;">... and ${filteredSensors.length - 100} more sensors</div>` : '');
                    }
                }
                
            } catch (error) {
                console.error('Error filtering sensors:', error);
            }
        }
        
        function closeDeviceDetail() {
            const modal = document.getElementById('deviceDetailModal');
            const backdrop = document.getElementById('modalBackdrop');
            modal.classList.remove('open');
            backdrop.classList.remove('open');
        }
        
        async function showSensorDetail(sensorId, sensorName) {
            const content = document.getElementById('deviceDetailContent');
            
            // Show loading state
            content.innerHTML = `
                <div class="loading-detail">
                    <i class="fas fa-spinner fa-spin"></i> Loading sensor details...
                </div>
            `;
            
            try {
                // Fetch sensor details and readings with authentication for enhanced data
                const authManager = window.dashboard.authManager;
                const [sensorResponse, readingsResponse] = await Promise.allSettled([
                    authManager.authenticatedFetch(`/api/sensors/${sensorId}`),
                    authManager.authenticatedFetch(`/api/sensors/${sensorId}/readings?hours=24&limit=100`)
                ]);
                
                let sensorData = null;
                let readingsData = { readings: [] };
                
                if (sensorResponse.status === 'fulfilled' && sensorResponse.value.ok) {
                    sensorData = await sensorResponse.value.json();
                }
                
                if (readingsResponse.status === 'fulfilled' && readingsResponse.value.ok) {
                    readingsData = await readingsResponse.value.json();
                }
                
                renderSensorDetailContent(sensorData, readingsData, sensorId, sensorName);
                
            } catch (error) {
                console.error('Error loading sensor details:', error);
                content.innerHTML = `
                    <div class="detail-section">
                        <div class="detail-section-title">Error</div>
                        <p>Failed to load sensor details. Please try again.</p>
                        <button onclick="showDeviceDetail(${sensorData?.deviceId || 'null'}, 'Device')" style="margin-top: 1rem; background: #3498db; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">â† Back to Device</button>
                    </div>
                `;
            }
        }
        
        function renderSensorDetailContent(sensorData, readingsData, sensorId, sensorName) {
            const content = document.getElementById('deviceDetailContent');
            const title = document.getElementById('deviceDetailTitle');
            
            title.textContent = `Sensor: ${sensorName}`;
            
            const sensor = sensorData || { id: sensorId, name: sensorName };
            const readings = readingsData?.readings || [];
            
            // Calculate statistics from readings
            const values = readings.map(r => parseFloat(r.value)).filter(v => !isNaN(v));
            const stats = {
                count: readings.length,
                min: values.length > 0 ? Math.min(...values) : 0,
                max: values.length > 0 ? Math.max(...values) : 0,
                avg: values.length > 0 ? (values.reduce((a, b) => a + b, 0) / values.length).toFixed(2) : 0,
                latest: readings.length > 0 ? readings[readings.length - 1] : null
            };
            
            content.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <button onclick="showDeviceDetail(${sensor.deviceId || 'null'}, '${sensor.device?.name || 'Device'}')" style="background: #95a5a6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">â† Back to Device</button>
                </div>
                
                <!-- Sensor Overview -->
                <div class="detail-section">
                    <div class="detail-section-title">Sensor Information</div>
                    <div class="detail-grid">
                        <div class="detail-label">Sensor ID</div>
                        <div class="detail-value">${sensor.id}</div>
                        <div class="detail-label">Sensor Type</div>
                        <div class="detail-value">${sensor.sensorType || sensor.sensor_type || 'Unknown'}</div>
                        <div class="detail-label">Current Status</div>
                        <div class="detail-value" style="color: ${getStatusColor(sensor.status)}">${getStatusText(sensor.status)}</div>
                        <div class="detail-label">Priority</div>
                        <div class="detail-value">${sensor.priority || 'Normal'}</div>
                        <div class="detail-label">Current Value</div>
                        <div class="detail-value">${sensor.lastValue || sensor.last_value || 'N/A'}</div>
                        <div class="detail-label">Last Message</div>
                        <div class="detail-value">${sensor.lastMessage || sensor.last_message ? (sensor.lastMessage || sensor.last_message).replace(/<[^>]*>/g, '') : 'N/A'}</div>
                        <div class="detail-label">Last Updated</div>
                        <div class="detail-value">${sensor.lastSeen ? new Date(sensor.lastSeen).toLocaleString() : 'N/A'}</div>
                    </div>
                </div>
                
                <!-- Performance Statistics -->
                <div class="detail-section">
                    <div class="detail-section-title">24-Hour Performance Statistics</div>
                    <div class="detail-grid">
                        <div class="detail-label">Data Points</div>
                        <div class="detail-value">${stats.count}</div>
                        <div class="detail-label">Minimum Value</div>
                        <div class="detail-value">${stats.min}</div>
                        <div class="detail-label">Maximum Value</div>
                        <div class="detail-value">${stats.max}</div>
                        <div class="detail-label">Average Value</div>
                        <div class="detail-value">${stats.avg}</div>
                        <div class="detail-label">Latest Reading</div>
                        <div class="detail-value">${stats.latest ? `${stats.latest.value} at ${new Date(stats.latest.timestamp).toLocaleString()}` : 'N/A'}</div>
                    </div>
                </div>
                
                <!-- Recent Readings -->
                <div class="detail-section">
                    <div class="detail-section-title">Recent Readings (Last 20)</div>
                    <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 1rem; max-height: 300px; overflow-y: auto;">
                        ${readings.length > 0 ? readings.slice(-20).reverse().map(reading => `
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span style="color: #95a5a6; font-size: 0.8rem;">${new Date(reading.timestamp).toLocaleString()}</span>
                                <span style="color: ${getStatusColor(reading.status)}; font-weight: 600;">${reading.value} ${reading.valueText || ''}</span>
                            </div>
                        `).join('') : '<p style="text-align: center; color: #95a5a6;">No readings available</p>'}
                    </div>
                </div>
                
                <!-- Threshold Information -->
                <div class="detail-section">
                    <div class="detail-section-title">Monitoring Configuration</div>
                    <div class="detail-grid">
                        <div class="detail-label">Monitoring Interval</div>
                        <div class="detail-value">${sensor.interval || 'Unknown'}</div>
                        <div class="detail-label">Warning Threshold</div>
                        <div class="detail-value">${sensor.warningThreshold || 'Not configured'}</div>
                        <div class="detail-label">Error Threshold</div>
                        <div class="detail-value">${sensor.errorThreshold || 'Not configured'}</div>
                        <div class="detail-label">Unit</div>
                        <div class="detail-value">${sensor.unit || 'N/A'}</div>
                    </div>
                </div>
            `;
        }
        
        function getStatusColor(status) {
            const colorMap = {
                3: '#27ae60',
                4: '#f39c12', 
                5: '#e74c3c',
                7: '#95a5a6',
                10: '#9b59b6',
                1: '#7f8c8d'
            };
            return colorMap[status] || '#7f8c8d';
        }
        
        function getStatusKey(status) {
            const statusMap = {
                3: 'up',
                4: 'warning',
                5: 'down',
                7: 'paused',
                10: 'unusual',
                1: 'unknown'
            };
            return statusMap[status] || 'unknown';
        }
        
        function getStatusText(status) {
            const statusMap = {
                3: 'Up/OK',
                4: 'Warning',
                5: 'Down/Error',
                7: 'Paused',
                10: 'Unusual',
                1: 'Unknown'
            };
            return statusMap[status] || 'Unknown';
        }
        
        // View switching functionality
        function switchView(viewName) {
            // Update navigation active state
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // For now, all views show the same content (overview)
            // In the future, this can be extended to show different views
            console.debug(`Switched to ${viewName} view`);
            
            // You can add view-specific logic here
            switch(viewName) {
                case 'overview':
                    // Already showing overview content
                    break;
                case 'topology':
                    // Navigate to 3D Network Topology
                    window.location.href = '/topology';
                    break;
                case 'alerts':
                    // TODO: Implement dedicated alerts view
                    alert('Dedicated alerts view coming soon!');
                    break;
                case 'analytics':
                    // TODO: Implement analytics dashboard
                    alert('Analytics dashboard coming soon!');
                    break;
                case 'reports':
                    // TODO: Implement reports section
                    alert('Reports section coming soon!');
                    break;
            }
        }

        // Security and User Menu Functions
        function toggleUserMenu() {
            const dropdown = document.getElementById('userMenuDropdown');
            dropdown.classList.toggle('active');
            
            // Close menu when clicking outside
            document.addEventListener('click', function closeMenu(e) {
                if (!e.target.closest('.user-menu-container')) {
                    dropdown.classList.remove('active');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        function showChangePassword() {
            const modal = document.createElement('div');
            modal.className = 'security-modal';
            modal.innerHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-header">
                            <h3>Change Password</h3>
                            <button onclick="closeModal()" style="background: none; border: none; color: #95a5a6; font-size: 1.5rem; cursor: pointer;">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="changePasswordForm" style="display: flex; flex-direction: column; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; color: #bdc3c7;">Current Password</label>
                                    <input type="password" id="currentPassword" required style="width: 100%; padding: 0.75rem; border: 1px solid #34495e; border-radius: 6px; background: #2c3e50; color: white;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; color: #bdc3c7;">New Password</label>
                                    <input type="password" id="newPassword" required style="width: 100%; padding: 0.75rem; border: 1px solid #34495e; border-radius: 6px; background: #2c3e50; color: white;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; color: #bdc3c7;">Confirm New Password</label>
                                    <input type="password" id="confirmPassword" required style="width: 100%; padding: 0.75rem; border: 1px solid #34495e; border-radius: 6px; background: #2c3e50; color: white;">
                                </div>
                                <div class="password-requirements" style="font-size: 0.75rem; color: #95a5a6;">
                                    <p>Password requirements:</p>
                                    <ul style="margin: 0.5rem 0; padding-left: 1rem;">
                                        <li>At least 8 characters</li>
                                        <li>At least one uppercase letter</li>
                                        <li>At least one lowercase letter</li>
                                        <li>At least one number</li>
                                    </ul>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                    <button type="button" onclick="closeModal()" style="flex: 1; background: #95a5a6; color: white; border: none; padding: 0.75rem; border-radius: 6px; cursor: pointer;">
                                        Cancel
                                    </button>
                                    <button type="submit" style="flex: 1; background: #3498db; color: white; border: none; padding: 0.75rem; border-radius: 6px; cursor: pointer;">
                                        Change Password
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('changePasswordForm').onsubmit = function(e) {
                e.preventDefault();
                handlePasswordChange();
            };
        }

        async function handlePasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }

            // Validate password strength
            if (!validatePasswordStrength(newPassword)) {
                alert('Password does not meet security requirements!');
                return;
            }

            // For PRTG systems, password changes are typically done through PRTG Web Interface
            // Show appropriate message and instructions
            closeModal();
            
            const infoModal = document.createElement('div');
            infoModal.className = 'security-modal';
            infoModal.innerHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3>Password Change Information</h3>
                            <button onclick="closeModal()" style="background: none; border: none; color: #95a5a6; font-size: 1.5rem; cursor: pointer;">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="text-align: center; padding: 1rem;">
                                <i class="fas fa-info-circle" style="font-size: 3rem; color: #3498db; margin-bottom: 1rem;"></i>
                                <h3>PRTG Password Management</h3>
                                <p style="margin: 1rem 0; line-height: 1.6;">
                                    Password changes for PRTG accounts are managed through the PRTG Web Interface or Active Directory (if configured).
                                </p>
                                <div style="background: rgba(52, 152, 219, 0.1); border: 1px solid rgba(52, 152, 219, 0.2); border-radius: 6px; padding: 1rem; margin: 1rem 0; text-align: left;">
                                    <h4 style="margin: 0 0 0.5rem 0; color: #3498db;">To change your password:</h4>
                                    <ol style="margin: 0; padding-left: 1.5rem; color: #bdc3c7;">
                                        <li>Access the PRTG Web Interface directly</li>
                                        <li>Go to Account Settings â†’ Setup â†’ Account Settings</li>
                                        <li>Update your password in the user management section</li>
                                        <li>Contact your PRTG administrator if needed</li>
                                    </ol>
                                </div>
                                <button onclick="closeModal()" style="background: #3498db; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; margin-top: 1rem;">
                                    Understood
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(infoModal);
        }

        function validatePasswordStrength(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            
            return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers;
        }

        function showSessionInfo() {
            const sessionData = window.securityManager.currentUser;
            const loginTime = sessionData ? new Date(sessionData.loginTime).toLocaleString() : 'Not logged in';
            const sessionDuration = sessionData ? formatDuration(Date.now() - sessionData.loginTime) : 'N/A';
            
            const modal = document.createElement('div');
            modal.className = 'security-modal';
            modal.innerHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-header">
                            <h3>Session Information</h3>
                            <button onclick="closeModal()" style="background: none; border: none; color: #95a5a6; font-size: 1.5rem; cursor: pointer;">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <div>
                                    <label style="display: block; font-weight: 600; color: #bdc3c7; margin-bottom: 0.25rem;">Username</label>
                                    <div style="color: white;">${sessionData?.username || 'Guest'}</div>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; color: #bdc3c7; margin-bottom: 0.25rem;">Role</label>
                                    <div style="color: white;">${sessionData?.role || 'Guest'}</div>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; color: #bdc3c7; margin-bottom: 0.25rem;">Login Time</label>
                                    <div style="color: white;">${loginTime}</div>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; color: #bdc3c7; margin-bottom: 0.25rem;">Session Duration</label>
                                    <div style="color: white;">${sessionDuration}</div>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; color: #bdc3c7; margin-bottom: 0.25rem;">Session ID</label>
                                    <div style="color: #95a5a6; font-family: monospace; font-size: 0.8rem;">${sessionData?.sessionId || 'N/A'}</div>
                                </div>
                            </div>
                            <button onclick="closeModal()" style="width: 100%; margin-top: 1.5rem; background: #3498db; color: white; border: none; padding: 0.75rem; border-radius: 6px; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        function closeModal() {
            const modals = document.querySelectorAll('.security-modal');
            modals.forEach(modal => modal.remove());
        }

        // Security handler functions
        function handleLogout() {
            try {
                // Close the user menu first
                const dropdown = document.getElementById('userMenuDropdown');
                if (dropdown) {
                    dropdown.classList.remove('active');
                }
                
                // Execute logout after a brief delay to allow menu to close
                setTimeout(() => {
                    try {
                        if (window.securityManager && typeof window.securityManager.logout === 'function') {
                            window.securityManager.logout();
                        } else {
                            console.error('SecurityManager not properly initialized');
                            // Try simple confirm as fallback
                            if (confirm('Are you sure you want to logout?')) {
                                localStorage.removeItem('securitySession');
                                sessionStorage.clear();
                                window.location.reload();
                            }
                        }
                    } catch (error) {
                        console.error('Error during logout:', error);
                        // Fallback logout
                        if (confirm('An error occurred. Force logout?')) {
                            localStorage.removeItem('securitySession');
                            sessionStorage.clear();
                            window.location.reload();
                        }
                    }
                }, 100);
            } catch (error) {
                console.error('Error in handleLogout:', error);
            }
        }

        async function handleSessionInfo() {
            if (window.securityManager) {
                try {
                    const sessionInfo = await window.securityManager.getSessionInfo();
                    showEDRSessionInfo(sessionInfo);
                } catch (error) {
                    console.error('Failed to get session info:', error);
                    alert('Failed to retrieve session information');
                }
            } else {
                alert('Session information not available');
            }
        }

        // Session expiry polling and flag display with live countdown
        (function initSessionExpiryWatcher(){
            const flag = document.getElementById('sessionExpiryFlag');
            const text = document.getElementById('sessionExpiryText');
            let serverPollInterval = null;
            let countdownInterval = null;
            let expiryTimestamp = null; // When the session will expire

            async function fetchStatus(){
                try {
                    const res = await fetch('/api/session/status', { credentials: 'same-origin' });
                    if (!res.ok) {
                        console.debug('Session status endpoint not available (404)');
                        return;
                    }
                    const data = await res.json();
                    if (data.restoredFromCache && data.expiresAt) {
                        // Use absolute expiry time from database (does NOT reset on activity)
                        const serverExpiryTime = new Date(data.expiresAt).getTime();
                        
                        // Only update if this is the first fetch OR if it's different from what we have
                        // This ensures the timer doesn't reset on every refresh
                        if (!expiryTimestamp || Math.abs(serverExpiryTime - expiryTimestamp) > 60000) {
                            expiryTimestamp = serverExpiryTime;
                            console.log('ðŸ• Session expiry set from database:', data.expiresAt);
                        }
                        
                        // Show flag and start live countdown
                        flag.style.display = 'flex';
                        startLiveCountdown();
                        
                        // Poll server every 10 minutes to sync (in case of DB updates)
                        if (!serverPollInterval) {
                            serverPollInterval = setInterval(async () => {
                                try {
                                    const r = await fetch('/api/session/status', { credentials: 'same-origin' });
                                    if (!r.ok) {
                                        console.debug('Session status endpoint not available (404)');
                                        return;
                                    }
                                    const d = await r.json();
                                    if (d.expiresAt) {
                                        const newExpiry = new Date(d.expiresAt).getTime();
                                        // Only update if significantly different (>1 minute difference)
                                        if (Math.abs(newExpiry - expiryTimestamp) > 60000) {
                                            expiryTimestamp = newExpiry;
                                            console.log('ðŸ”„ Session expiry synced from database:', d.expiresAt);
                                        }
                                    }
                                } catch (e) {
                                    console.warn('Failed to sync session status:', e);
                                }
                            }, 10 * 60 * 1000); // 10 minutes
                        }
                    } else {
                        // Hide flag and stop timers
                        flag.style.display = 'none';
                        stopTimers();
                    }
                } catch (e) {
                    // silent
                }
            }

            function startLiveCountdown() {
                // Clear existing countdown if any
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }
                
                // Update immediately
                updateCountdownDisplay();
                
                // Then update every second
                countdownInterval = setInterval(() => {
                    updateCountdownDisplay();
                }, 1000);
            }

            function updateCountdownDisplay() {
                if (!expiryTimestamp) return;
                
                const timeLeftMs = Math.max(0, expiryTimestamp - Date.now());
                const totalSec = Math.floor(timeLeftMs / 1000);
                const hours = Math.floor(totalSec / 3600);
                const min = Math.floor((totalSec % 3600) / 60);
                const sec = totalSec % 60;
                
                // Format display based on time remaining
                if (hours > 0) {
                    text.textContent = `Session ends in: ${hours}h ${String(min).padStart(2,'0')}m ${String(sec).padStart(2,'0')}s`;
                } else {
                    text.textContent = `Time remaining: ${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
                }
                
                // Toggle critical styling under 5 minutes
                if (timeLeftMs <= 5 * 60 * 1000) {
                    flag.classList.add('critical');
                } else {
                    flag.classList.remove('critical');
                }
                
                // If expired, redirect to login
                if (timeLeftMs <= 0) {
                    console.warn('â° Session expired, redirecting to login...');
                    stopTimers();
                    window.location.href = '/login?expired=1';
                }
            }

            function stopTimers() {
                if (serverPollInterval) {
                    clearInterval(serverPollInterval);
                    serverPollInterval = null;
                }
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                expiryTimestamp = null;
            }

            function formatTime(ms) {
                const totalSec = Math.floor(ms / 1000);
                const hours = Math.floor(totalSec / 3600);
                const min = Math.floor((totalSec % 3600) / 60);
                const sec = totalSec % 60;
                return `${hours}h ${min}m ${sec}s`;
            }

            function updateCountdown(ms){
                // Legacy function - now handled by startLiveCountdown
                expiryTimestamp = Date.now() + ms;
                startLiveCountdown();
            }

            // Initial check
            fetchStatus();
        })();

        function showEDRSessionInfo(sessionInfo) {
            const riskLevel = sessionInfo.riskScore < 25 ? 'Low' : 
                             sessionInfo.riskScore < 50 ? 'Medium' : 
                             sessionInfo.riskScore < 75 ? 'High' : 'Critical';
            
            const riskColor = sessionInfo.riskScore < 25 ? '#27ae60' : 
                             sessionInfo.riskScore < 50 ? '#f39c12' : 
                             sessionInfo.riskScore < 75 ? '#e67e22' : '#e74c3c';

            const modal = document.createElement('div');
            modal.className = 'security-modal';
            modal.innerHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3><i class="fas fa-shield-alt"></i> EDR Session Information</h3>
                            <button onclick="closeModal()" style="background: none; border: none; color: #95a5a6; font-size: 1.5rem; cursor: pointer;">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="display: grid; gap: 1rem;">
                                <!-- Session Details -->
                                <div style="background: linear-gradient(135deg, #34495e, #2c3e50); padding: 1rem; border-radius: 8px;">
                                    <h4 style="margin: 0 0 0.5rem 0; color: #3498db;"><i class="fas fa-user"></i> Session Details</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
                                        <div><strong>Username:</strong> ${sessionInfo.username}</div>
                                        <div><strong>Role:</strong> ${sessionInfo.role}</div>
                                        <div><strong>Session ID:</strong> ${sessionInfo.sessionId.substr(0, 16)}...</div>
                                        <div><strong>Duration:</strong> ${sessionInfo.durationMinutes} minutes</div>
                                        <div><strong>Login Time:</strong> ${new Date(sessionInfo.loginTime).toLocaleString()}</div>
                                        <div><strong>Last Activity:</strong> ${new Date(sessionInfo.lastActivity).toLocaleString()}</div>
                                    </div>
                                </div>

                                <!-- Security Status -->
                                <div style="background: linear-gradient(135deg, #2c3e50, #34495e); padding: 1rem; border-radius: 8px;">
                                    <h4 style="margin: 0 0 0.5rem 0; color: #e74c3c;"><i class="fas fa-shield-alt"></i> Security Status</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
                                        <div><strong>Risk Score:</strong> <span style="color: ${riskColor}; font-weight: bold;">${sessionInfo.riskScore}/100 (${riskLevel})</span></div>
                                        <div><strong>Security Events:</strong> ${sessionInfo.securityEvents}</div>
                                        <div><strong>IP Address:</strong> ${sessionInfo.ipAddress}</div>
                                        <div><strong>Anomalies:</strong> ${sessionInfo.anomalies}</div>
                                    </div>
                                    <div style="margin-top: 0.5rem;">
                                        <div style="background: rgba(0,0,0,0.3); border-radius: 4px; height: 8px; overflow: hidden;">
                                            <div style="background: ${riskColor}; height: 100%; width: ${sessionInfo.riskScore}%; transition: width 0.3s;"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Technical Details -->
                                <div style="background: linear-gradient(135deg, #34495e, #2c3e50); padding: 1rem; border-radius: 8px;">
                                    <h4 style="margin: 0 0 0.5rem 0; color: #9b59b6;"><i class="fas fa-desktop"></i> Technical Details</h4>
                                    <div style="font-size: 0.8rem; color: #bdc3c7;">
                                        <div style="margin-bottom: 0.5rem;"><strong>User Agent:</strong><br>${sessionInfo.userAgent}</div>
                                    </div>
                                </div>

                                <!-- Recent Activities -->
                                <div style="background: linear-gradient(135deg, #2c3e50, #34495e); padding: 1rem; border-radius: 8px;">
                                    <h4 style="margin: 0 0 0.5rem 0; color: #f39c12;"><i class="fas fa-history"></i> Recent Activities</h4>
                                    <div style="max-height: 150px; overflow-y: auto; font-size: 0.8rem;">
                                        ${sessionInfo.activities.map(activity => `
                                            <div style="padding: 0.25rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                                <span style="color: #3498db;">${new Date(activity.timestamp).toLocaleTimeString()}</span> - 
                                                ${activity.action} ${activity.details ? '(' + activity.details + ')' : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div style="text-align: center; padding-top: 1rem;">
                                    <button onclick="closeModal()" style="background: #3498db; color: white; border: none; padding: 0.75rem 2rem; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                        <i class="fas fa-check"></i> Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function handleChangePassword() {
            if (window.securityManager) {
                showChangePassword();
            } else {
                alert('Password change not available');
            }
        }

        function handleRefresh() {
            console.log('ðŸ”„ Refresh initiated - clearing stale data');
            
            // Add visual feedback
            const refreshBtn = document.querySelector('.refresh-btn');
            if (refreshBtn) {
                const icon = refreshBtn.querySelector('i');
                if (icon) {
                    icon.classList.add('fa-spin');
                }
                refreshBtn.disabled = true;
            }
            
            // Clear any stale cached data
            try {
                // Clear dashboard data
                if (window.dashboard) {
                    window.dashboard.devices = [];
                    window.dashboard.companies.clear();
                }
                
                // Clear localStorage cache if any
                localStorage.removeItem('dashboardCache');
                localStorage.removeItem('lastLoadTime');
                
                // Force reconnection attempt
                if (window.dashboard && window.dashboard.ws) {
                    try {
                        window.dashboard.ws.close();
                    } catch (e) {
                        console.debug('WebSocket close error (expected):', e);
                    }
                }
                
                console.log('âœ… Stale data cleared, forcing full reload');
            } catch (error) {
                console.warn('Error clearing stale data:', error);
            }
            
            // Force a hard reload instead of soft refresh
            setTimeout(() => {
                window.location.reload(true);
            }, 100);
        }

        function navigateToAdmin(path) {
            closeAdminQuickMenu();
            window.location.href = path;
        }

        function toggleAdminQuickMenu(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('adminQuickDropdown');
            const button = document.getElementById('adminPortalBtn');
            if (!dropdown || !button) return;
            const willOpen = !dropdown.classList.contains('open');
            if (willOpen) {
                dropdown.classList.add('open');
                button.classList.add('active');
                adminQuickOutsideHandler = (e) => {
                    if (!dropdown.contains(e.target) && e.target !== button) {
                        closeAdminQuickMenu();
                    }
                };
                document.addEventListener('click', adminQuickOutsideHandler);
            } else {
                closeAdminQuickMenu();
            }
        }

        function closeAdminQuickMenu() {
            const dropdown = document.getElementById('adminQuickDropdown');
            const button = document.getElementById('adminPortalBtn');
            if (dropdown) dropdown.classList.remove('open');
            if (button) button.classList.remove('active');
            if (adminQuickOutsideHandler) {
                document.removeEventListener('click', adminQuickOutsideHandler);
                adminQuickOutsideHandler = null;
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            monitorStartupProgress().catch(error => console.debug('Startup progress monitor error:', error));
            window.securityManager = new SecurityManager();
            window.dashboard = new SOCDashboard();
            await syncSessionContext();
            
            // Check for openDevice URL parameter from topology
            const urlParams = new URLSearchParams(window.location.search);
            const openDeviceId = urlParams.get('openDevice');
            if (openDeviceId) {
                // Wait for dashboard to load, then open the device
                setTimeout(() => {
                    const deviceId = parseInt(openDeviceId);
                    // Find device name from loaded devices
                    const device = window.dashboard.allDevices.find(d => d.id === deviceId);
                    if (device) {
                        showDeviceDetail(deviceId, device.name);
                    } else {
                        showDeviceDetail(deviceId, 'Device');
                    }
                }, 2000); // Wait 2 seconds for dashboard to load
            }
            
            // Add beforeunload handler to attempt logout when tab/window closes
            // Note: This is best-effort, as browsers limit what can be done in this event
            window.addEventListener('beforeunload', (e) => {
                // Use sendBeacon for reliable last-minute logout notification
                // This is more reliable than fetch() during page unload
                if (navigator.sendBeacon && document.cookie.includes('edr.sid')) {
                    console.log('ðŸšª Attempting graceful logout on tab close...');
                    try {
                        navigator.sendBeacon('/logout', JSON.stringify({}));
                    } catch (err) {
                        console.warn('Beacon logout failed:', err);
                    }
                }
            });
        });
    </script>

    <!-- Device Detail Modal -->
    <div class="modal-backdrop" id="modalBackdrop" onclick="closeDeviceDetail()"></div>
    <div class="device-detail-modal" id="deviceDetailModal">
        <div class="detail-header">
            <div class="detail-title" id="deviceDetailTitle">Device Details</div>
            <button class="close-detail" onclick="closeDeviceDetail()">&times;</button>
        </div>
        <div class="detail-content" id="deviceDetailContent">
            <div class="loading-detail">
                <i class="fas fa-spinner fa-spin"></i> Loading device details...
            </div>
        </div>
    </div>
</body>
</html>